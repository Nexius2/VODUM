{% extends "base.html" %}
{% set active_page = 'discord' %}

{% block title %}{{ t("discord") }} - VODUM{% endblock %}
{% block header_title %}{{ t("discord") }}{% endblock %}
{% block header_subtitle %}{{ t("discord_subtitle") }}{% endblock %}

{% block header_actions %}{% endblock %}

{% block content %}
{% set current_subpage = 'settings' %}
{% include "discord/discord_nav.html" %}

<!-- SWITCH discord_enabled -->
<div class="flex items-center gap-3 mb-4">
  <label class="text-slate-300 font-medium">{{ t("discord_enabled") }}</label>

  <label class="relative inline-flex items-center cursor-pointer">
    <input type="checkbox"
           id="discord_enabled_switch"
           class="sr-only peer"
           {% if settings.discord_enabled %}checked{% endif %}
           {% if not settings.discord_bot_token_effective %}disabled title=\"{{ t('discord_connect_first') }}\"{% endif %}>

    <div class="w-11 h-6 bg-slate-600 rounded-full peer peer-checked:bg-green-500 transition-colors"></div>
    <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform
                peer-checked:translate-x-5 shadow"></div>

    <span class="ml-3 text-xs text-slate-400">
      {% if settings.discord_enabled %}
        {{ t("discord_enabled_on") }}
      {% else %}
        {{ t("discord_enabled_off") }}
      {% endif %}
    </span>
  </label>
</div>

{% if settings.discord_bot_token_effective %}
  <div class="mb-4 text-xs text-slate-400">
    {{ t('discord_connected_as') }}:
    <span class="text-slate-200 font-semibold">{{ settings.discord_bot_username_effective or t('unknown') }}</span>
  </div>
{% else %}
  <div class="mb-4 text-xs text-slate-500">
    {{ t('discord_not_configured') }}
  </div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 text-xs">

  <!-- Help -->
  <div class="lg:col-span-1 bg-slate-900 border border-slate-800 rounded-2xl p-4 space-y-3">
    <h2 class="text-sm font-semibold mb-2">{{ t("discord_help_title") }}</h2>

    <p class="text-slate-400">
      {{ t("discord_help_1") }}
    </p>

    <ul class="list-disc list-inside text-slate-400 space-y-1">
      <li>{{ t("discord_help_need_bot") }}</li>
      <li>{{ t("discord_help_need_user_id") }}</li>
    </ul>

    <div class="pt-2">
      <a href="https://discord.com/developers/applications" target="_blank" rel="noopener"
         class="inline-flex items-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded text-xs">
        {{ t('discord_open_developer_portal') }}
      </a>
      <div class="mt-2 text-slate-500">{{ t('discord_help_create_steps') }}</div>
    </div>

  </div>

  <!-- Settings -->
  <div class="lg:col-span-2 bg-slate-900 border border-slate-800 rounded-2xl p-4 space-y-6">

    <!-- 1) I already have a bot -->
    <div class="border border-slate-800 rounded-2xl p-4 bg-slate-950/40">
      <div class="text-slate-200 font-semibold mb-1">{{ t("discord_have_bot_title") }}</div>
      <div class="text-slate-500 mb-3">{{ t("discord_have_bot_help") }}</div>

      <form method="post" class="space-y-3">
        <input type="hidden" name="action" value="connect_token">

        <div>
          <label class="block mb-1 text-slate-400">{{ t("discord_bot_token") }}</label>
          <div class="relative">
			<input type="password"
				   id="bot_token_connect"
				   name="bot_token"
				   autocomplete="new-password"
				   autocapitalize="off"
				   autocorrect="off"
				   spellcheck="false"
				   value="{% if settings.discord_bot_token_effective %}‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢{% endif %}"
				   class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-xs pr-10"
				   placeholder="{{ t('discord_bot_token_placeholder') }}">


            <button type="button"
                    data-toggle="bot_token_connect"
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white text-sm">üëÅÔ∏è</button>
          </div>
          <p class="text-slate-500 mt-1">{{ t("discord_token_help") }}</p>
        </div>

        <button type="submit"
                class="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded text-xs">
          {{ t("discord_connect") }}
        </button>
      </form>

      {% if settings.discord_bot_id %}
        <form method="post" class="mt-3">
          <input type="hidden" name="action" value="delete_bot">
          <button type="submit"
                  onclick="return confirm('{{ t('discord_delete_bot_confirm') }}');"
                  class="px-3 py-2 bg-red-700 hover:bg-red-600 text-white rounded text-xs">
            {{ t("discord_delete_bot") }}
          </button>
        </form>
      {% endif %}
    </div>

    <div class="text-slate-500 text-xs">
      {{ t("discord_note_tasks") }}
    </div>

  </div>
</div>

<script>
  // -------------------------
  // Toggle enable/disable (API)
  // -------------------------
  const sw = document.getElementById("discord_enabled_switch");
  const statusSpan = sw?.closest("label")?.querySelector("span");
  const initialSpanText = statusSpan ? statusSpan.textContent : "";

  function flash(category, msg) {
    if (typeof window.vodumFlash === "function") {
      window.vodumFlash(category, msg);
    } else {
      console.log(`[${category}] ${msg}`);
    }
  }

  sw?.addEventListener("change", async () => {
    const enabled = sw.checked;

    if (statusSpan) {
      statusSpan.textContent = enabled ? "{{ t('discord_enabled_on') }}" : "{{ t('discord_enabled_off') }}";
    }

    const res = await fetch("/api/discord/toggle", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ enabled })
    });

    if (!res.ok) {
      sw.checked = !enabled;
      if (statusSpan) statusSpan.textContent = initialSpanText;

      let detail = "";
      try {
        const data = await res.json();
        if (data?.message) detail = ` (${data.message})`;
        else if (data?.error) detail = ` (${data.error})`;
      } catch (_) {}

      flash("error", "Discord: toggle failed" + detail);
      return;
    }

    flash("success", enabled ? "Discord activ√©" : "Discord d√©sactiv√©");
  });

  // -------------------------
  // Show/hide token inputs
  // -------------------------
	document.querySelectorAll('button[data-toggle]').forEach((btn) => {
	  btn.addEventListener('click', async () => {
		const id = btn.getAttribute('data-toggle');
		const input = document.getElementById(id);
		if (!input) return;

		// If we are about to show the token and the field is empty,
		// load the saved token from backend (admin-only UI feature).
		if (input.type === "password") {
			const masked = (input.value || "").includes("‚Ä¢‚Ä¢‚Ä¢‚Ä¢");

			if (!input.value || input.value.trim() === "" || masked) {
			  try {
				const res = await fetch("/api/discord/token", { method: "GET" });
				if (res.ok) {
				  const data = await res.json();
				  if (data?.token) input.value = data.token;
				}
			  } catch (e) {}
			}


		  input.type = "text";
		  btn.textContent = "üôà";
		} else {
		  input.type = "password";
		  btn.textContent = "üëÅÔ∏è";
		}
	  });
	});



</script>

{% endblock %}
