<div class="space-y-6">

  <!-- Header -->
  <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold mb-2">
          {{ t("policies_title") }}
        </h2>

        <p class="text-slate-400 text-sm">
          {{ t("policies_intro") }}
          <span class="mx-1">•</span>
          {{ t("policies_task_label") }}
          <code class="text-slate-200">stream_enforcer</code>
        </p>

        <p class="text-slate-500 text-xs mt-2">
          {{ t("policies_note_providers") }}
        </p>
      </div>

      <div class="shrink-0">
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-950 border border-slate-800 text-xs text-slate-300">
          <span class="w-2 h-2 rounded-full bg-indigo-500"></span>
          {{ t("policies_scan_every_60s") }}
        </span>
      </div>
    </div>
  </div>

  <!-- Create policy -->
  <form method="post"
        action="{{ url_for('stream_policy_create') }}"
        class="bg-slate-900 border border-slate-800 rounded-xl p-4 grid grid-cols-1 md:grid-cols-3 gap-4">

    <input type="hidden" name="policy_id" value="{{ edit_policy.id if edit_policy else '' }}">

    <!-- Rule -->
    <div>
      <label class="text-xs text-slate-400">
        {{ t("policies_rule") }}
      </label>

      <select name="rule_type"
              class="w-full mt-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2">
        <option value="max_streams_per_user" {% if edit_policy and edit_policy.rule_type=="max_streams_per_user" %}selected{% endif %}>{{ t("policies_rule_max_streams_user") }}</option>
		<option value="max_ips_per_user" {% if edit_policy and edit_policy.rule_type=="max_ips_per_user" %}selected{% endif %}>{{ t("policies_rule_max_ips_user") }}</option>
		<option value="max_streams_per_ip" {% if edit_policy and edit_policy.rule_type=="max_streams_per_ip" %}selected{% endif %}>{{ t("policies_rule_max_streams_ip") }}</option>
        <option value="max_transcodes_global" {% if edit_policy and edit_policy.rule_type=="max_transcodes_global" %}selected{% endif %}>{{ t("policies_rule_max_transcodes_server") }}</option>
        <option value="ban_4k_transcode" {% if edit_policy and edit_policy.rule_type=="ban_4k_transcode" %}selected{% endif %}>{{ t("policies_rule_ban_4k_transcode") }}</option>
        <option value="max_bitrate_kbps" {% if edit_policy and edit_policy.rule_type=="max_bitrate_kbps" %}selected{% endif %}>{{ t("policies_rule_max_bitrate") }}</option>
        <option value="device_allowlist" {% if edit_policy and edit_policy.rule_type=="device_allowlist" %}selected{% endif %}>{{ t("policies_rule_device_allowlist") }}</option>
      </select>
    </div>

    <!-- Scope -->
    <div>
      <label class="text-xs text-slate-400">
        {{ t("policies_scope") }}
      </label>

      <select name="scope_type"
              class="w-full mt-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2">
        <option value="global" {% if edit_policy and edit_policy.scope_type=="global" %}selected{% endif %}>{{ t("policies_scope_global") }}</option>
        <option value="server" {% if edit_policy and edit_policy.scope_type=="server" %}selected{% endif %}>{{ t("policies_scope_server") }}</option>
        <option value="user" {% if edit_policy and edit_policy.scope_type=="user" %}selected{% endif %}>{{ t("policies_scope_user") }}</option>
      </select>

      <input name="scope_id"
             value="{{ edit_policy.scope_id if edit_policy else '' }}"
             placeholder="{{ t('policies_scope_id_placeholder') }}"
             class="w-full mt-2 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2" />
      <p class="text-xs text-slate-500 mt-1">
        {{ t("policies_scope_help") }}
      </p>
    </div>

    <!-- Provider + server filter -->
    <div>
      <label class="text-xs text-slate-400">
        {{ t("policies_provider") }}
      </label>

      <select name="provider"
              class="w-full mt-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2">
        <option value="" {% if edit_policy and not edit_policy.provider %}selected{% endif %}>{{ t("policies_provider_both") }}</option>
        <option value="plex" {% if edit_policy and edit_policy.provider=="plex" %}selected{% endif %}>{{ t("policies_provider_plex") }}</option>
        <option value="jellyfin" {% if edit_policy and edit_policy.provider=="jellyfin" %}selected{% endif %}>{{ t("policies_provider_jellyfin") }}</option>
      </select>

      <label class="text-xs text-slate-400 mt-3 block">
        {{ t("policies_server_filter") }}
        <span class="text-slate-500">({{ t("optional") }})</span>
      </label>

      <select name="server_id"
              class="w-full mt-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2">
        <option value="" {% if edit_policy and not edit_policy.server_id %}selected{% endif %}>{{ t("policies_all_servers") }}</option>
        {% for s in servers %}
          <option value="{{ s.id }}" {% if edit_policy and edit_policy.server_id==s.id %}selected{% endif %}>{{ s.name }} ({{ s.type }})</option>
        {% endfor %}
      </select>
    </div>

    <!-- Priority / Selector / Enabled -->
    <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="text-xs text-slate-400">
          {{ t("policies_priority") }}
        </label>
        <input name="priority"
               value="{{ edit_policy.priority if edit_policy else 100 }}"
               class="w-full mt-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2" />
        <p class="text-xs text-slate-500 mt-1">
          {{ t("policies_priority_help") }}
        </p>
      </div>

      <div>
        <label class="text-xs text-slate-400">
          {{ t("policies_selector") }}
        </label>

        <select name="selector"
                class="w-full mt-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2">
          <option value="kill_newest" {% if edit_policy and edit_policy._rule.selector=="kill_newest" %}selected{% endif %}>{{ t("policies_selector_kill_newest") }}</option>
          <option value="kill_oldest" {% if edit_policy and edit_policy._rule.selector=="kill_oldest" %}selected{% endif %}>{{ t("policies_selector_kill_oldest") }}</option>
          <option value="kill_transcoding_first" {% if edit_policy and edit_policy._rule.selector=="kill_transcoding_first" %}selected{% endif %}>{{ t("policies_selector_kill_transcoding") }}</option>
        </select>

        <p class="text-xs text-slate-500 mt-1">
          {{ t("policies_selector_help") }}
        </p>
      </div>

      <div>
        <label class="text-xs text-slate-400">
          {{ t("policies_enabled") }}
        </label>

        <select name="is_enabled"
                class="w-full mt-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2">
          <option value="1" {% if not edit_policy or edit_policy.is_enabled %}selected{% endif %}>{{ t("enabled") }}</option>
          <option value="0" {% if edit_policy and not edit_policy.is_enabled %}selected{% endif %}>{{ t("disabled") }}</option>
        </select>
      </div>
    </div>

    <!-- Rule values -->
    <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="text-xs text-slate-400">
          {{ t("policies_max_value") }}
        </label>
        <input name="max_value"
               value="{{ edit_policy._rule.max if edit_policy and (edit_policy._rule.max is defined) else '' }}"
               placeholder="{{ t('policies_max_value_placeholder') }}"
               class="w-full mt-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2" />
        <p class="text-xs text-slate-500 mt-1">
          {{ t("policies_max_value_help") }}
        </p>

        <label class="mt-3 flex items-center gap-2 text-xs text-slate-300">
          <input type="checkbox" name="allow_local_ip" value="1"
                 {% if edit_policy and edit_policy._rule.allow_local_ip %}checked{% endif %}>
          {{ t("policies_allow_local_ip") }}
        </label>
        <p class="text-xs text-slate-500 mt-1">
          {{ t("policies_allow_local_ip_help") }}
        </p>
      </div>

      <div>
        <label class="text-xs text-slate-400">
          {{ t("policies_max_bitrate_kbps") }}
        </label>
        <input name="max_kbps"
               value="{{ edit_policy._rule.max_kbps if edit_policy and (edit_policy._rule.max_kbps is defined) else '' }}"
               placeholder="{{ t('policies_max_bitrate_placeholder') }}"
               class="w-full mt-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2" />
        <p class="text-xs text-slate-500 mt-1">
          {{ t("policies_max_bitrate_help") }}
        </p>
      </div>

      <div>
        <label class="text-xs text-slate-400">
          {{ t("policies_allowed_devices") }}
        </label>
        <input name="allowed_devices"
               value="{{ (edit_policy._rule.allowed|join(', ')) if edit_policy and (edit_policy._rule.allowed is defined) else '' }}"
               placeholder="{{ t('policies_allowed_devices_placeholder') }}"
               class="w-full mt-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2" />
        <p class="text-xs text-slate-500 mt-1">
          {{ t("policies_allowed_devices_help") }}
        </p>
      </div>
    </div>

    <!-- Warn message -->
    <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="text-xs text-slate-400">
          {{ t("policies_warn_title") }}
        </label>
        <input name="warn_title"
               value="{{ edit_policy._rule.warn_title if edit_policy and (edit_policy._rule.warn_title is defined) else t('policies_warn_title_default') }}"
               class="w-full mt-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2" />
      </div>

      <div>
        <label class="text-xs text-slate-400">
          {{ t("policies_warn_text") }}
        </label>
        <input name="warn_text"
               value="{{ edit_policy._rule.warn_text if edit_policy and (edit_policy._rule.warn_text is defined) else t('policies_warn_text_default') }}"
               class="w-full mt-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2" />
      </div>
    </div>

    <div class="md:col-span-3 flex justify-end gap-2">
      {% if edit_policy %}
        <a href="{{ url_for('monitoring_page', tab='policies') }}"
           class="px-4 py-2 rounded-lg border border-slate-700 bg-slate-950/40 text-slate-200 hover:bg-slate-950/70 font-semibold">
          {{ t("cancel") }}
        </a>
      {% endif %}
      <button class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg font-semibold">
        {% if edit_policy %}{{ t("save") }}{% else %}{{ t("policies_create_button") }}{% endif %}
      </button>
    </div>
  </form>

  <!-- List policies -->
  <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
    <div class="p-4 border-b border-slate-800 flex items-center justify-between">
      <h3 class="font-semibold">
        {{ t("policies_existing_title") }}
      </h3>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-950 text-slate-400">
          <tr>
            <th class="text-left p-3">{{ t("id") }}</th>
            <th class="text-left p-3">{{ t("enabled") }}</th>
            <th class="text-left p-3">{{ t("priority") }}</th>
            <th class="text-left p-3">{{ t("scope") }}</th>
			<th class="text-left p-3">{{ t("user_id") }}</th>
            <th class="text-left p-3">{{ t("provider") }}</th>
            <th class="text-left p-3">{{ t("rule") }}</th>
            <th class="text-left p-3">{{ t("value") }}</th>
            <th class="text-left p-3"></th>
          </tr>
        </thead>

        <tbody>
          {% for p in policies %}
            <tr class="border-t border-slate-800">
              <td class="p-3 text-slate-200">{{ p.id }}</td>

              <td class="p-3">
                {% if p.is_enabled %}
                  <span class="inline-flex items-center gap-1 text-emerald-400">
                    <span>●</span>{{ t("enabled") }}
                  </span>
                {% else %}
                  <span class="text-slate-500">—</span>
                {% endif %}
              </td>

              <td class="p-3">{{ p.priority }}</td>

				<!-- Scope -->
				<td class="p-3">
				  <div class="flex flex-wrap items-center gap-2">
					<span class="text-slate-300">{{ p.scope_type }}</span>

					{% if p.scope_type == "user" %}
					  <span class="text-slate-500">
						{{ p.scope_username if p.scope_username else "" }}
					  </span>
					{% else %}
					  <span class="text-slate-500">
						{{ p.scope_id or "" }}
					  </span>
					{% endif %}

					{% if p._is_system %}
					  <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-slate-950 border border-slate-700 text-[11px] text-slate-300">
						{{ t("system") }}
					  </span>
					{% endif %}
				  </div>
				</td>

				<!-- User ID (dédié) -->
				<td class="p-3 text-slate-500">
				  {% if p.scope_type == "user" %}
					#{{ p.scope_id }}
				  {% else %}
					<span class="text-slate-600">—</span>
				  {% endif %}
				</td>


              <td class="p-3">
                {% if p.provider %}
                  {{ p.provider }}
                {% else %}
                  {{ t("policies_provider_both_short") }}
                {% endif %}
              </td>

              <td class="p-3">{{ p.rule_type }}</td>

              <td class="p-3 text-slate-400">
                <code class="whitespace-pre-wrap break-words">{{ p.rule_value_json }}</code>
              </td>

              <td class="p-3 text-right">
                <div class="flex items-center justify-end gap-3">
                  {% if p._is_system %}
                    <span class="text-slate-500 text-xs">{{ t("read_only") }}</span>
                  {% else %}
                    <a class="text-slate-300 hover:text-white" href="{{ url_for('stream_policy_edit', policy_id=p.id) }}">{{ t("edit") }}</a>
                    <form method="post" action="{{ url_for('stream_policy_delete', policy_id=p.id) }}">
                      <button class="text-red-400 hover:text-red-300">{{ t("delete") }}</button>
                    </form>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}

          {% if not policies %}
            <tr>
              <td class="p-4 text-slate-400" colspan="9">
                {{ t("policies_empty") }}
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

</div>
