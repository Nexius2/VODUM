<div class="bg-slate-900 border border-slate-800 rounded-2xl p-5">
  <div class="flex items-center justify-between mb-4">
    <div class="text-sm font-semibold">History</div>
    <div class="text-xs text-slate-400">30 rows / page</div>
  </div>

  {% if rows is not defined %}
    <div class="text-slate-500">
      Backend not wired yet: variable <code class="text-slate-300">rows</code> missing.
    </div>
  {% else %}
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
		<thead>
		{% set current_sort = sort_key or "date" %}
		{% set current_dir  = sort_dir or "desc" %}

		<tr class="border-b border-slate-800 text-left">

		{% macro th(label, key) %}
		  {% set active = (current_sort == key) %}
		  {% set next_dir = "asc" if (active and current_dir == "desc") else "desc" %}
		  {% set args = dict(request.args) %}
		  {% set _ = args.update({
			  "tab": "history",
			  "sort": key,
			  "dir": next_dir,
			  "page": 1
		  }) %}
		  <th class="py-2 pr-4">
			<a href="{{ url_for('monitoring_page', **args) }}"
			   class="inline-flex items-center gap-2
					  {{ 'text-emerald-400 font-semibold' if active else 'text-slate-400' }}">
			  {{ label }}
			  {% if active %}
				{{ '▲' if current_dir == 'asc' else '▼' }}
			  {% else %}
				↕
			  {% endif %}
			</a>
		  </th>
		{% endmacro %}

		{{ th("Date", "date") }}
		{{ th("User", "user") }}
		{{ th("Server", "server") }}
		{{ th("Media", "media") }}
		{{ th("Type", "type") }}
		{{ th("Playback", "playback") }}
		{{ th("Device", "device") }}
		{{ th("Duration", "duration") }}

		</tr>
		</thead>

        <tbody>
          {% for r in rows %}
            <tr class="border-b border-slate-800">
              <td class="py-3 pr-4">{{ r.stopped_at|tz }}</td>
              <td class="py-3 pr-4">{{ r.username or "-" }}</td>
              <td class="py-3 pr-4">
                <div class="font-semibold">{{ r.server_name }}</div>
                <div class="text-xs text-slate-500">{{ r.provider }}</div>
              </td>
              <td class="py-3 pr-4">
                <div class="font-semibold">{{ r.title or "-" }}</div>
                {% if r.grandparent_title %}
                  <div class="text-xs text-slate-500">{{ r.grandparent_title }}</div>
                {% endif %}
              </td>
              <td class="py-3 pr-4">{{ r.media_type or "-" }}</td>
              <td class="py-3 pr-4">{{ r.playback_type or "-" }}</td>
              <td class="py-3 pr-4">{{ r.device or "-" }}</td>
              <td class="py-3 pr-4">{{ r.watch_time or "-" }}</td>
            </tr>
          {% endfor %}
          {% if rows|length == 0 %}
            <tr><td colspan="8" class="py-6 text-slate-500">No results.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if pagination is defined %}
      {% include "monitoring/partials/_pagination.html" %}
    {% endif %}
  {% endif %}
</div>
