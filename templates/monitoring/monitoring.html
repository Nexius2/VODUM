{% extends "base.html" %}

{% block title %}{{ t("monitoring.title") }}{% endblock %}
{% block header_title %}{{ t("monitoring.title") }}{% endblock %}
{% block header_subtitle %}{{ t("monitoring.subtitle") }}{% endblock %}

{% block content %}

{% include "monitoring/partials/_tabs.html" %}

{# Construit l'URL actuelle (tab + filtres/pagination) pour HTMX #}
{% set args = request.args.to_dict() %}
{% if args.get('tab') is none %}
  {% set _ = args.update({'tab':'overview'}) %}
{% endif %}

{# Interval par onglet (tu peux ajuster) #}
{% set current_tab = args.get('tab', 'overview') %}

{% if current_tab == 'activity' %}
  {% set refresh_ms = 5000 %}
{% elif current_tab == 'now_playing' %}
  {% set refresh_ms = 2500 %}
{% elif current_tab == 'policies' %}
  {% set refresh_ms = 600000 %}
{% elif current_tab == 'servers' %}
  {% set refresh_ms = 15000 %}
{% elif current_tab == 'overview' %}
  {% set refresh_ms = 10000 %}
{% elif current_tab in ['history', 'users', 'libraries'] %}
  {% set refresh_ms = 30000 %}
{% else %}
  {% set refresh_ms = 10000 %}
{% endif %}

{# ------------------------------------------------------------
   Helper : quel template inclure pour l’onglet courant
   (évite les doublons + gère "overview" qui n'est pas dans tabs/)
------------------------------------------------------------ #}
{% set tab_template = "monitoring/tabs/" ~ current_tab ~ ".html" %}
{% if current_tab == "overview" %}
  {% set tab_template = "monitoring/overview_body.html" %}
{% endif %}

{% if current_tab in ['activity', 'servers'] %}
  {# ✅ PAS de HTMX sur Activity + Servers => pas de clignotement (charts) #}
  <div id="monitoring-content">
    {% include tab_template %}
  </div>
{% else %}
  {# ✅ HTMX conservé pour les autres onglets (auto-refresh OK) #}
  <div id="monitoring-content"
       hx-get="{{ url_for('monitoring_page', **args) }}"
       hx-trigger="every {{ refresh_ms }}ms"
       hx-swap="innerHTML">
    {# ✅ contenu initial pour éviter un blanc #}
    {% include tab_template %}
  </div>
{% endif %}

<script>
(function () {
  function initMonitoringUsersSearch() {
    const form = document.getElementById("monitoring_users_filter_form");
    const input = document.getElementById("monitoring_users_search_input");
    if (!form || !input) return;

    // éviter de binder 15 fois si htmx reload
    if (input.dataset.bound === "1") return;
    input.dataset.bound = "1";

    let timer = null;

    function submitForm() {
      const page = form.querySelector('input[name="page"]');
      if (page) page.value = "1";
      if (form.requestSubmit) form.requestSubmit();
      else form.submit();
    }

    input.addEventListener("input", () => {
      clearTimeout(timer);
      timer = setTimeout(submitForm, 800);
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        clearTimeout(timer);
        submitForm();
      }
    });
  }

  // 1) chargement normal
  document.addEventListener("DOMContentLoaded", initMonitoringUsersSearch);

  // 2) chargement via HTMX (tabs swap)
  document.addEventListener("htmx:load", initMonitoringUsersSearch);
})();
</script>



{% endblock %}
