{% extends "base.html" %}
{% set active_page = "subscriptions" %}

{% block title %}{{ t("subscriptions") }} - VODUM{% endblock %}
{% block header_title %}{{ t("subscriptions") }}{% endblock %}
{% block header_subtitle %}{{ t("subscriptions_description") }}{% endblock %}

{% block content %}

<!-- Bandeau comme Tasks (success/error) -->
<div id="page-alert" class="hidden mb-6"></div>

<form id="gift-form"
      action="{{ url_for('subscriptions_api.api_gift_subscription') }}"
      method="post"
      onsubmit="event.preventDefault(); submitGift();">

  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6 max-w-5xl">

      <!-- ========================= -->
      <!-- TARGET USERS -->
      <!-- ========================= -->
      <h2 class="text-sm uppercase tracking-wide text-slate-400 mb-3">
          {{ t("target_users") }}
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">

          <!-- ALL USERS -->
          <label class="cursor-pointer">
              <input type="radio"
                     name="target_type"
                     value="all"
                     checked
                     class="hidden"
                     onchange="toggleServerSelect(false)">

              <div id="card-all"
                   class="p-4 rounded-xl border border-primary bg-primary/10">
                  <div class="font-medium mb-1">{{ t("all_users") }}</div>
                  <div class="text-sm text-slate-400">{{ t("subscriptions_all_users_hint") }}</div>
              </div>
          </label>

          <!-- USERS FROM SERVER -->
          <label class="cursor-pointer">
              <input type="radio"
                     name="target_type"
                     value="server"
                     class="hidden"
                     onchange="toggleServerSelect(true)">

              <div id="card-server"
                   class="p-4 rounded-xl border border-slate-800">
                  <div class="font-medium mb-1">{{ t("users_from_server") }}</div>
                  <div class="text-sm text-slate-400">{{ t("subscriptions_server_users_hint") }}</div>
              </div>
          </label>
      </div>

      <!-- SERVER SELECT (hidden unless server mode) -->
      <div id="server-select" class="mt-3 max-w-sm hidden">
          <select name="server_id"
                  class="bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-sm w-full">
              <option value="">{{ t("select_server") }}</option>
              {% for server in servers %}
                  <option value="{{ server.id }}">{{ server.name }}</option>
              {% endfor %}
          </select>
      </div>

      <!-- ========================= -->
      <!-- GIFT DURATION -->
      <!-- ========================= -->
      <h2 class="text-sm uppercase tracking-wide text-slate-400 mt-8 mb-3">
          {{ t("gift_duration") }}
      </h2>

      <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-8">
          {% set durations = [
              (1, t("one_day")),
              (7, t("seven_days")),
              (30, t("one_month")),
              (90, t("three_months")),
              (180, t("six_months")),
              (365, t("one_year"))
          ] %}

          {% for value, label in durations %}
          <label class="cursor-pointer">
              <input type="radio"
                     name="days"
                     value="{{ value }}"
                     class="hidden"
                     {% if loop.first %}checked{% endif %}
                     onchange="selectDuration(this)">

              <div class="duration-card text-center p-3 rounded-xl border
                   {% if loop.first %}
                     border-emerald-400 bg-emerald-400/10
                   {% else %}
                     border-slate-800
                   {% endif %}">
                  <span class="font-medium">{{ label }}</span>
              </div>
          </label>
          {% endfor %}
      </div>

      <!-- ========================= -->
      <!-- OPTIONS -->
      <!-- ========================= -->
      <h2 class="text-sm uppercase tracking-wide text-slate-400 mb-3">
          {{ t("options") }}
      </h2>

      <div class="max-w-md mb-4">
          <input type="text"
                 name="reason"
                 placeholder="{{ t('reason_placeholder') }}"
                 class="bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-sm w-full">
      </div>

      <div class="text-sm text-slate-400 mb-8">
          {{ t("subscription_reset_notice") }}
      </div>

      <!-- ========================= -->
      <!-- ACTION -->
      <!-- ========================= -->
      <div class="flex justify-end">
          <!-- bouton SUBMIT => utilise onsubmit (donc pas de navigation JSON) -->
          <button type="submit"
                  class="px-5 py-2 rounded-lg bg-primary hover:bg-primary-dark text-white font-medium">
              üéÅ {{ t("gift_subscription") }}
          </button>
      </div>

  </div>
</form>

<script>
/* =========================
   I18N STRINGS (inject√©es)
   ========================= */
const I18N = {
  users_updated: "{{ t('users_updated') }}",
  days_added: "{{ t('days_added') }}",
  unknown_error: "{{ t('unknown_error') }}",
  request_failed: "{{ t('request_failed') }}"
};

/* =========================
   UI HELPERS
   ========================= */

function toggleServerSelect(show) {
  document.getElementById("server-select")
          .classList.toggle("hidden", !show);

  const all = document.getElementById("card-all");
  const srv = document.getElementById("card-server");

  all.classList.remove("border-primary","bg-primary/10");
  all.classList.add("border-slate-800");

  srv.classList.remove("border-primary","bg-primary/10");
  srv.classList.add("border-slate-800");

  if (!show) {
    all.classList.add("border-primary","bg-primary/10");
  } else {
    srv.classList.add("border-primary","bg-primary/10");
  }
}

function selectDuration(input) {
  document.querySelectorAll(".duration-card").forEach(card => {
    card.classList.remove("border-emerald-400", "bg-emerald-400/10");
    card.classList.add("border-slate-800");
  });

  const card = input.closest("label").querySelector(".duration-card");
  card.classList.remove("border-slate-800");
  card.classList.add("border-emerald-400", "bg-emerald-400/10");
}

function showAlert(type, html) {
  const alertBox = document.getElementById("page-alert");
  alertBox.classList.remove("hidden");

  if (type === "success") {
    alertBox.className =
      "mb-6 rounded-lg bg-emerald-500/10 border border-emerald-500 text-emerald-300 px-4 py-3";
  } else {
    alertBox.className =
      "mb-6 rounded-lg bg-red-500/10 border border-red-500 text-red-300 px-4 py-3";
  }

  alertBox.innerHTML = html;
  alertBox.scrollIntoView({ behavior: "smooth", block: "start" });
}

/* =========================
   FORM SUBMIT
   ========================= */

function submitGift() {
  const form = document.getElementById("gift-form");
  const data = new FormData(form);

  fetch(form.action, { method: "POST", body: data })
    .then(r => r.json())
    .then(res => {
      if (res.status === "ok") {
        showAlert(
          "success",
          `üéÅ <strong>${res.users_updated}</strong> ${I18N.users_updated}
           (+${res.days_added} ${I18N.days_added})`
        );
      } else {
        showAlert(
          "error",
          `‚ùå ${res.error || I18N.unknown_error}`
        );
      }
    })
    .catch(() => {
      showAlert(
        "error",
        `‚ùå ${I18N.request_failed}`
      );
    });
}
</script>


{% endblock %}
