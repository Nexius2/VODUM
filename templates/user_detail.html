{% extends "base.html" %}
{% set active_page = 'users' %}

{% block title %}{{ t("user") }} - {{ user.username }}{% endblock %}

{% block header_title %}
{{ t("user") }}: {{ user.username }}
{% endblock %}

{% block header_actions %}
<button form="user_main_form"
        class="px-4 py-2 rounded-lg bg-primary hover:bg-primary-dark text-white text-sm">
    {{ t("save") }}
</button>
{% endblock %}

{% block header_subtitle %}
{{ t("user_management_subtitle") }}
{% endblock %}


{% block content %}

<!-- TOP GRID : infos + right column -->
<div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">

<!-- ====================== INFOS G√âN√âRALES (2/3) ====================== -->
<form method="post" id="user_main_form" class="xl:col-span-2">
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
    <h2 class="text-sm font-semibold mb-4">{{ t("general_info") }}</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

      <!-- Username -->
      <label class="text-sm">
        {{ t("username") }}
        <input type="text" value="{{ user.username }}" readonly
               class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 opacity-60 cursor-not-allowed">
      </label>

      <!-- Email (user) -->
      <label class="text-sm">
        {{ t("email") }}
        <input type="text" value="{{ user.email }}" readonly
               class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 opacity-60 cursor-not-allowed">
      </label>

      <!-- First name -->
      <label class="text-sm">
        {{ t("firstname") }}
        <input type="text" name="firstname" value="{{ user.firstname or '' }}"
               class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2">
      </label>

      <!-- Secondary email -->
      <label class="text-sm">
        {{ t("second_email") }}
        <input type="text" name="second_email" value="{{ user.second_email or '' }}"
               class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2">
      </label>

      <!-- Last name -->
      <label class="text-sm">
        {{ t("lastname") }}
        <input type="text" name="lastname" value="{{ user.lastname or '' }}"
               class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2">
      </label>

<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

  <!-- Status -->
  <div class="flex items-center gap-2">
    <span class="text-sm text-slate-400">{{ t("status") }}:</span>

    {% set colors = {
      'active': 'bg-emerald-900/40 text-emerald-300',
      'pre_expired': 'bg-amber-900/40 text-amber-300',
      'reminder': 'bg-blue-900/40 text-blue-300',
      'expired': 'bg-rose-900/40 text-rose-300',
      'invited': 'bg-cyan-900/40 text-cyan-300',
      'unfriended': 'bg-slate-700 text-slate-300',
      'suspended': 'bg-purple-900/40 text-purple-300',
      'unknown': 'bg-slate-800 text-slate-400'
    } %}

    <span class="px-3 py-1 text-xs rounded-full {{ colors.get(user.status, 'bg-slate-800 text-slate-400') }}">
      {{ t(user.status) }}
    </span>
  </div>

  <!-- Last status -->
  <div class="flex items-center gap-2">
    <span class="text-sm text-slate-400">{{ t("last_status") }}:</span>

    <span class="px-3 py-1 text-xs rounded-full bg-slate-800 text-slate-300">
      {{ t(user.last_status) if user.last_status else t("not_available") }}
    </span>
  </div>

</div>



    </div>

    <!-- BADGES -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">



      <!-- (placeholder / flags if you want later) -->
      <div class="flex flex-wrap items-center gap-2">
        <!-- Nothing here on purpose (space kept like before) -->
      </div>
    </div>

    <!-- INTERNAL SUBSCRIPTION -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">

      <label class="text-sm">
        {{ t("expiration") }}
        <input type="date" name="expiration_date"
               value="{{ user.expiration_date or '' }}"
               class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2">
      </label>

      <label class="text-sm">
        {{ t("renewal_date") }}
        <input type="date" name="renewal_date"
               value="{{ user.renewal_date or '' }}"
               class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2">
      </label>

      <label class="text-sm md:col-span-2">
        {{ t("renewal_method") }}
        <input type="text" name="renewal_method"
               value="{{ user.renewal_method or '' }}"
               class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2">
      </label>

      <label class="text-sm">
        {{ t("creation_date") }}
		<input type="text"
			   value="{{ (user.created_at|tz).split(' ')[0] if user.created_at else t('not_available') }}"
			   readonly
			   class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 opacity-60 cursor-not-allowed">

      </label>

      <label class="text-sm">
        {{ t("status_changed_at") }}
		<input type="text"
			   value="{{ (user.status_changed_at|tz).split(' ')[0] if user.status_changed_at else t('not_available') }}"
			   readonly
			   class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 opacity-60 cursor-not-allowed">

      </label>

    </div>

    <!-- NOTES (moved here) -->
    <div class="mt-6">
      <h2 class="text-sm font-semibold mb-2">{{ t("notes") }}</h2>
      <textarea id="notes_field" name="notes" rows="8"
        class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-sm resize-vertical">{{ user.notes or '' }}</textarea>
    </div>

  </div>
</form>


<!-- ====================== RIGHT COLUMN : PLEX / JELLYFIN / EMAIL ====================== -->
<div class="flex flex-col gap-6">

  <!-- ========== PLEX BUBBLE (read-only) ========== -->
{% set plex_accounts = servers | selectattr("media_type", "equalto", "plex") | list %}
{% if plex_accounts %}

{# On prend le 1er compte Plex (si plusieurs serveurs Plex, tu pourras faire une boucle plus tard) #}
{% set p = plex_accounts[0] %}

<div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">

  <!-- HEADER -->

<div class="flex flex-col mb-3">

  <!-- Ligne unique : titre + r√¥le + avatar -->
<div class="flex items-center justify-between mb-3">
  <h2 class="text-sm font-semibold">Plex</h2>

  {# DB v2: avatar vient du media_user (p.media_avatar). Fallback sur user.avatar si pr√©sent #}
  {% if p.media_avatar %}
    <img src="{{ p.media_avatar }}"
         alt="Plex avatar"
         class="w-10 h-10 rounded-full border border-slate-700">
  {% elif user.avatar %}
    <img src="{{ user.avatar }}"
         alt="Plex avatar"
         class="w-10 h-10 rounded-full border border-slate-700">
  {% endif %}
</div>


  <!-- Plex flags (inchang√©s, juste d√©plac√©s) -->
  <div class="flex flex-wrap gap-2 mt-2">
    {# DB v2: ces flags sont souvent dans raw_json c√¥t√© media_users, pas dans vodum_users.
       On ne supprime rien: on garde tes conditions, mais elles risquent d'√™tre fausses tant que tu ne les importes pas. #}
    {% if user.home %}
      <span class="px-2 py-0.5 text-xs rounded bg-emerald-900/40 text-emerald-300">
        üè† {{ t("home_user") }}
      </span>
    {% endif %}

    {% if user.protected %}
      <span class="px-2 py-0.5 text-xs rounded bg-purple-900/40 text-purple-300">
        üîí {{ t("protected_account") }}
      </span>
    {% endif %}

    {% if user.restricted %}
      <span class="px-2 py-0.5 text-xs rounded bg-red-900/40 text-red-300 opacity-90">
        ‚õî {{ t("restricted") }}
      </span>
    {% endif %}
  </div>

</div>


  <!-- INFOS PRINCIPALES -->
  <div class="grid grid-cols-2 gap-y-2 text-sm mt-4">
    <div class="text-slate-400">{{ t("plex_id") }}</div>
    {# DB v2: plex id = external_user_id sur media_users #}
    <div class="font-mono text-slate-200">{{ p.external_user_id or t("not_available") }}</div>

    <div class="text-slate-400">{{ t("plex_role") }}</div>
    {# DB v2: role = media_role sur ta query (alias) #}
    <div class="text-slate-200">{{ p.media_role or t("not_available") }}</div>

    <div class="text-slate-400">{{ t("joined_at") }}</div>
    <div class="text-slate-200">{{ p.joined_at or t("not_available") }}</div>

    <div class="text-slate-400">{{ t("accepted_at") }}</div>
    <div class="text-slate-200">{{ p.accepted_at or t("not_available") }}</div>
  </div>

  <!-- PLEX PASS FLAG -->
  {# DB v2: subscription_* n'est pas dans ton query media_users actuellement.
     On garde ton bloc sans le supprimer, mais il ne s'affichera que si tu importes ces champs plus tard. #}
  {% if user.subscription_active %}
    <div class="mt-4">
      <span class="px-3 py-1 text-xs rounded-full bg-amber-900/40 text-amber-300">
        ‚≠ê Plex Pass
      </span>
    </div>
  {% endif %}

  <!-- PLEX PASS DETAILS -->
  <div class="mt-3 bg-slate-950/60 border border-slate-800 rounded-xl p-4">
    <div class="text-xs font-semibold text-slate-300 mb-3">
      Plex Pass
    </div>

    <div class="grid grid-cols-2 gap-y-2 text-sm">
      <div class="text-slate-400">{{ t("subscription_active") }}</div>
      <div class="text-slate-200">
        {{ user.subscription_active if user.subscription_active is not none else t("not_available") }}
      </div>

      <div class="text-slate-400">{{ t("subscription_status") }}</div>
      <div class="text-slate-200">{{ user.subscription_status or t("not_available") }}</div>

      <div class="text-slate-400">{{ t("subscription_plan") }}</div>
      <div class="text-slate-200">{{ user.subscription_plan or t("not_available") }}</div>
    </div>
  </div>

</div>
{% endif %}


  <!-- ========== JELLYFIN BUBBLE (placeholder read-only) ========== -->
  {# DB v2: jellyfin_id n'est pas sur vodum_users. On garde ton code,
     mais on ajoute la d√©tection via servers pour que √ßa s'affiche. #}
  {% set jellyfin_accounts = servers | selectattr("media_type", "equalto", "jellyfin") | list %}
  {% if user.jellyfin_id or jellyfin_accounts %}
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
    <h2 class="text-sm font-semibold mb-2">Jellyfin</h2>
    <p class="text-xs text-slate-500">
      {{ t("not_available") }}
    </p>
  </div>
  {% endif %}


  <!-- ========== EMAIL HISTORY (unchanged content, just moved) ========== -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
    <h2 class="text-sm font-semibold mb-2">{{ t("email_history") }}</h2>

    {% if sent_emails %}
    <div class="max-h-48 overflow-y-auto border border-slate-800 rounded-xl">
      <table class="w-full text-xs">
        <thead class="bg-slate-950/60 text-slate-400 sticky top-0">
          <tr>
            <th class="px-3 py-2 text-left">{{ t("type") }}</th>
            <th class="px-3 py-2 text-left">{{ t("snapshot") }}</th>
            <th class="px-3 py-2 text-left">{{ t("date") }}</th>
          </tr>
        </thead>
        <tbody>
          {% for m in sent_emails %}
          <tr class="border-t border-slate-800">
		  <td class="px-3 py-2">{{ t(m.template_type) }}</td>
		  <td class="px-3 py-2 text-slate-400">{{ m.expiration_date }}</td>
		  <td class="px-3 py-2 text-slate-300">{{ m.sent_at }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-xs text-slate-500">{{ t("no_email_sent") }}</p>
    {% endif %}
  </div>

</div>

</div>

<!-- ====================== SERVERS + LIBRARIES (UNCHANGED) ====================== -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">

{% for s in servers %}
{% set is_owner = (s.media_role or '')|lower == 'owner' %}

<div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 flex flex-col gap-4
            {% if is_owner %} opacity-70 {% endif %}">


  <!-- Server Header -->
  <div class="flex items-start justify-between pb-2">
    <div>
      <div class="text-sm font-semibold">{{ s.name }}</div>
      <div class="text-xs text-slate-400 break-all">
        {{ s.url or s.local_url or s.public_url or t("not_available") }}
      </div>
    </div>

    {% if s.has_access %}
      <span class="px-3 py-1 rounded-full text-xs bg-emerald-900/40 text-emerald-300">
        {{ t("access") }}
      </span>
    {% else %}
      <span class="px-3 py-1 rounded-full text-xs bg-slate-800 text-slate-300">
        {{ t("no_access") }}
      </span>
    {% endif %}
  </div>

  <div class="border-t border-slate-700/40"></div>

  <!-- Libraries + Options -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">

    <!-- Libraries -->
    <div class="space-y-2 md:pr-4">
      <div class="font-semibold text-slate-300 text-sm mb-1">{{ t("libraries") }}</div>

      {% set libs_for_server = libraries | selectattr("server_name", "equalto", s.name) | list %}

      {% if libs_for_server|length == 0 %}
        <p class="text-xs text-slate-500 italic">{{ t("no_library_for_server") }}</p>
      {% else %}
        {% for lib in libs_for_server %}
			<form method="post"
				  action="{{ url_for('user_toggle_library', user_id=user.id) }}"
				  class="flex items-center justify-between py-1
						 {% if is_owner %} pointer-events-none opacity-70 {% endif %}">


            <div>
              <input type="hidden" name="library_id" value="{{ lib.id }}">
              <span class="text-sm">{{ lib.name }}</span>
              <span class="text-xs text-slate-400">¬∑ {{ t(lib.type) }}</span>
            </div>

			<button type="submit"
			  class="relative inline-flex h-6 w-11 items-center rounded-full transition
					 {% if lib.has_access %} bg-emerald-500 {% else %} bg-slate-600 {% endif %}
					 {% if is_owner %} cursor-not-allowed {% endif %}">

              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition
                {% if lib.has_access %} translate-x-5 {% else %} translate-x-1 {% endif %}">
              </span>
            </button>

          </form>
        {% endfor %}
      {% endif %}
    </div>

    <!-- Server options -->
    {# DB v2: on utilise directement s (d√©j√† enrichi c√¥t√© app.py) #}
    {% set o = s %}

	<div class="md:pl-4 md:border-l md:border-slate-700/30 mt-2 md:mt-0">
	  <div class="bg-slate-800/40 border border-slate-700 rounded-xl p-3 text-xs space-y-2 h-fit">

		<div class="font-semibold text-slate-300 mb-1">
		  {{ t("server_options") }}
		</div>

        {# Les options ci-dessous sont sp√©cifiques Plex. Pour Jellyfin, on affiche "Not available". #}
        {% if s.media_type == 'plex' %}

          <!-- Editable options -->
			<label class="flex justify-between items-center gap-2
						  {% if is_owner %} opacity-60 cursor-not-allowed {% endif %}">
			  {{ t("allow_sync") }}
			  <input type="checkbox"
					 name="allow_sync_{{ s.media_user_id }}"
					 {% if o.allow_sync %}checked{% endif %}
					 {% if is_owner %}disabled{% endif %}>
			</label>

			<label class="flex justify-between items-center gap-2
						  {% if is_owner %} opacity-60 cursor-not-allowed {% endif %}">
			  {{ t("allow_camera_upload") }}
			  <input type="checkbox"
					 name="allow_camera_upload_{{ s.media_user_id }}"
					 {% if o.allow_camera_upload %}checked{% endif %}
					 {% if is_owner %}disabled{% endif %}>
			</label>

			<label class="flex justify-between items-center gap-2
						  {% if is_owner %} opacity-60 cursor-not-allowed {% endif %}">
			  {{ t("allow_channels") }}
			  <input type="checkbox"
					 name="allow_channels_{{ s.media_user_id }}"
					 {% if o.allow_channels %}checked{% endif %}
					 {% if is_owner %}disabled{% endif %}>
			</label>

			<label class="flex flex-col
						  {% if is_owner %} opacity-60 {% endif %}">
			  {{ t("filter_movies") }}
			  <input type="text"
					 name="filter_movies_{{ s.media_user_id }}"
					 value="{{ o.filter_movies }}"
					 {% if is_owner %}readonly{% endif %}
					 class="mt-1 w-full bg-slate-900 border border-slate-700 rounded px-2 py-1
							{% if is_owner %} cursor-not-allowed {% endif %}">
			</label>

			<label class="flex flex-col
						  {% if is_owner %} opacity-60 {% endif %}">
			  {{ t("filter_television") }}
			  <input type="text"
					 name="filter_television_{{ s.media_user_id }}"
					 value="{{ o.filter_television }}"
					 {% if is_owner %}readonly{% endif %}
					 class="mt-1 w-full bg-slate-900 border border-slate-700 rounded px-2 py-1
							{% if is_owner %} cursor-not-allowed {% endif %}">
			</label>

			<label class="flex flex-col
						  {% if is_owner %} opacity-60 {% endif %}">
			  {{ t("filter_music") }}
			  <input type="text"
					 name="filter_music_{{ s.media_user_id }}"
					 value="{{ o.filter_music }}"
					 {% if is_owner %}readonly{% endif %}
					 class="mt-1 w-full bg-slate-900 border border-slate-700 rounded px-2 py-1
							{% if is_owner %} cursor-not-allowed {% endif %}">
			</label>


        {% else %}
          <p class="text-xs text-slate-500 italic">{{ t("not_available") }}</p>
        {% endif %}

	  </div>
	</div>

  </div>

</div>
{% endfor %}

</div>

<script>
document.querySelector('[form="user_main_form"]')
  .addEventListener('click', function () {

    const mainForm = document.getElementById('user_main_form');

    // Nettoie les anciens champs dynamiques (√©vite doublons)
    mainForm.querySelectorAll('input[data-dyn="1"]').forEach(el => el.remove());

    // üîπ BIBLIOTH√àQUES (toggles)
    document.querySelectorAll('form[action*="toggle_library"]').forEach(f => {
      const libId = f.querySelector('input[name="library_id"]').value;
      const enabled = f.querySelector('button').classList.contains('bg-emerald-500');

      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'library_' + libId;
      input.value = enabled ? '1' : '0';
      input.setAttribute('data-dyn', '1');
      mainForm.appendChild(input);
    });

    // üîπ OPTIONS SERVEUR (hors form) -> on copie en hidden pour le POST
    const selectors = [
      'input[name^="allow_sync_"]',
      'input[name^="allow_camera_upload_"]',
      'input[name^="allow_channels_"]',
      'input[name^="filter_movies_"]',
      'input[name^="filter_television_"]',
      'input[name^="filter_music_"]'
    ];

    document.querySelectorAll(selectors.join(',')).forEach(el => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = el.name;
      input.setAttribute('data-dyn', '1');

      if (el.type === 'checkbox') {
        input.value = el.checked ? '1' : '0';
      } else {
        input.value = el.value || '';
      }

      mainForm.appendChild(input);
    });

  });
</script>

{% endblock %}
