{% extends "base.html" %}
{% set active_page = 'users' %}

{% block title %}{{ t("users_title") }} - VODUM{% endblock %}
{% block header_title %}{{ t("users") }}{% endblock %}
{% block header_subtitle %}{{ t("users_subtitle") }}{% endblock %}

{% block content %}

<style>
    /* Curseur propre partout dans les colonnes triables */
    th.sortable, th.sortable * {
        cursor: pointer !important;
    }

    /* Style flÃ¨che */
    th .arrow {
        width: 12px;
        height: 12px;
        opacity: 0.35;
        transition: transform 0.2s ease, opacity 0.2s ease;
    }

    th.sorted .arrow {
        opacity: 1;
        color: rgb(52 211 153); /* emerald-400 */
    }

    th.sorted-asc .arrow {
        transform: rotate(0deg);
    }

    th.sorted-desc .arrow {
        transform: rotate(180deg);
    }

    th.sorted span {
        color: rgb(52 211 153);
    }
</style>

<div class="flex items-center justify-end mb-4">
  <button id="btn_create_user" type="button"
          class="text-sm px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white">
    + Create user
  </button>
</div>


<!-- Filtres -->
<form method="get" id="users_filter_form" class="flex flex-wrap items-center gap-3 mb-6">

    <!-- Search -->
    <input type="text"
           name="q"
           placeholder="{{ t('search') }}â€¦"
           value="{{ search }}"
           class="bg-slate-900 border border-slate-800 rounded-lg text-sm px-3 py-2 w-56">

    <!-- Status multiselect -->
	<details class="relative">
	  <summary class="list-none cursor-pointer bg-slate-900 border border-slate-800 rounded-lg text-sm px-3 py-2 flex items-center gap-2">
		<span>{{ t("status") }}</span>
		<span class="text-xs text-slate-400">
		  ({{ (selected_statuses|length) if selected_statuses else "all" }})
		</span>
		<svg class="w-4 h-4 opacity-70" viewBox="0 0 24 24">
		  <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2"/>
		</svg>
	  </summary>

	  <div class="absolute z-20 mt-2 w-64 bg-slate-950 border border-slate-800 rounded-xl p-3 shadow-xl">
		{% set all_statuses = ['active','pre_expired','reminder','expired','invited','unfriended','suspended','unknown'] %}

		<!-- Quick actions -->
		<div class="flex items-center justify-between mb-2">
		  <button type="button"
				  class="text-xs text-slate-300 hover:text-white underline"
				  onclick="this.closest('details').querySelectorAll('input[name=status]').forEach(i => i.checked = true);">
			Select all
		  </button>

		  <button type="button"
				  class="text-xs text-slate-300 hover:text-white underline"
				  onclick="this.closest('details').querySelectorAll('input[name=status]').forEach(i => i.checked = false);">
			Select none
		  </button>
		</div>

		<div class="space-y-2 max-h-56 overflow-y-auto pr-1">
		  {% for s in all_statuses %}
			<label class="flex items-center justify-between gap-2 text-sm">
			  <span class="text-slate-200">{{ t(s) }}</span>
			  <input type="checkbox" name="status" value="{{ s }}"
					 {# âœ… si rien n'est sÃ©lectionnÃ© -> on coche tout par dÃ©faut #}
					 {% if (not selected_statuses) or (s in selected_statuses) %}checked{% endif %}>
			</label>
		  {% endfor %}
		</div>
	  </div>
	</details>

<!-- 
    <button class="text-sm px-4 py-2 rounded-lg bg-primary hover:bg-primary-dark text-white">
        {{ t("filter") }}
    </button>

    <a href="{{ url_for('users_list') }}"
       class="text-sm px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">
        {{ t("reset") }}
    </a>-->
</form>



<!-- TABLE USERS -->
<div class="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden">
<table class="w-full text-sm">
    <thead class="bg-slate-950/60 text-slate-400">
        <tr>
            <!-- NAME -->
            <th class="px-4 py-3 text-left sortable" onclick="sortTable(0, this)">
                <div class="flex items-center gap-1 cursor-pointer">
                    <span>{{ t("name") }}</span>
                    <svg class="arrow" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
            </th>

            <!-- EMAIL -->
            <th class="px-4 py-3 text-left sortable" onclick="sortTable(1, this)">
                <div class="flex items-center gap-1 cursor-pointer">
                    <span>{{ t("email") }}</span>
                    <svg class="arrow" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
            </th>

            <!-- STATUS -->
            <th class="px-4 py-3 text-left sortable" onclick="sortTable(2, this)">
                <div class="flex items-center gap-1 cursor-pointer">
                    <span>{{ t("status") }}</span>
                    <svg class="arrow" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
            </th>

            <!-- EXPIRATION -->
            <th class="px-4 py-3 text-left sortable" onclick="sortTable(3, this)">
                <div class="flex items-center gap-1 cursor-pointer">
                    <span>{{ t("expiration") }}</span>
                    <svg class="arrow" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
            </th>

            <!-- SERVERS -->
            <th class="px-4 py-3 text-left sortable" onclick="sortTable(4, this)">
                <div class="flex items-center gap-1 cursor-pointer">
                    <span>{{ t("servers") }}</span>
                    <svg class="arrow" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
            </th>

            <!-- LIBRARIES -->
            <th class="px-4 py-3 text-left sortable" onclick="sortTable(5, this)">
                <div class="flex items-center gap-1 cursor-pointer">
                    <span>{{ t("libraries") }}</span>
                    <svg class="arrow" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
            </th>

        </tr>
    </thead>

    <tbody>
        {% for u in users %}
        <tr class="border-t border-slate-800 hover:bg-slate-800/50 cursor-pointer"
            onclick="window.location='{{ url_for('user_detail', user_id=u.id) }}'">

            <td class="px-4 py-3">{{ u.username }}</td>
            <td class="px-4 py-3 text-slate-300"
				data-sort-value="{{ u.email or '' }}">
			  {{ u.email or t("not_available") }}
			</td>


            <td class="px-4 py-3">
                {% set colors = {
                    'active': 'bg-emerald-900/40 text-emerald-300',
                    'pre_expired': 'bg-amber-900/40 text-amber-300',
                    'expired': 'bg-rose-900/40 text-rose-300',
                    'reminder': 'bg-blue-900/40 text-blue-300',
                    'invited': 'bg-cyan-900/40 text-cyan-300',
                    'unfriended': 'bg-slate-700 text-slate-300',
                    'suspended': 'bg-purple-900/40 text-purple-300',
                    'unknown': 'bg-slate-800 text-slate-400'
                } %}
                <span class="text-xs px-2 py-1 rounded-full {{ colors.get(u.status) }}"
					  data-status="{{ u.status }}">
					{{ t(u.status) }}
				</span>

            </td>

            <td class="px-4 py-3 text-slate-300"
				data-sort-value="{{ u.expiration_date or '' }}">
			  {{ u.expiration_date or t("not_available") }}
			</td>
            <td class="px-4 py-3 text-slate-300">{{ u.servers_count }}</td>
            <td class="px-4 py-3 text-slate-300">{{ u.libraries_count }}</td>

        </tr>

        {% else %}
        <tr>
            <td colspan="6" class="px-4 py-6 text-center text-slate-500">
                {{ t("no_user_found") }}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>


<!-- SCRIPT TRI + MÃ‰MOIRE -->
<script>
function sortTable(columnIndex, thElement) {
    const table = document.querySelector("table");
    if (!table) return;

    const tbody = table.querySelector("tbody");
    if (!tbody) return;

    const rows = Array.from(tbody.querySelectorAll("tr"))
        .filter(r => !r.querySelector("td[colspan]"));

    const thList = table.querySelectorAll("th.sortable");

    thList.forEach(th => {
        th.classList.remove("sorted", "sorted-asc", "sorted-desc");
    });

    const currentOrder = thElement.dataset.order === "asc" ? "desc" : "asc";
    thElement.dataset.order = currentOrder;
    thElement.classList.add(
        "sorted",
        currentOrder === "asc" ? "sorted-asc" : "sorted-desc"
    );

    /* =========================
       HELPERS
       ========================= */

    // ðŸ”‘ Valeur rÃ©elle utilisÃ©e pour le tri (i18n-safe)
    function getCellValue(cell) {
        if (cell?.dataset?.sortValue !== undefined) {
            return cell.dataset.sortValue;
        }
        return cell?.innerText || "";
    }

    // ðŸ”¢ Conversion vers valeur comparable
    function convert(v) {
        v = (v || "").trim();

        // valeur absente â†’ toujours Ã  la fin
        if (v === "") return Number.POSITIVE_INFINITY;

        // YYYY-MM-DD
        if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
            return new Date(v).getTime();
        }

        // DD/MM/YYYY
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(v)) {
            const [d, m, y] = v.split("/").map(Number);
            return new Date(y, m - 1, d).getTime();
        }

        // nombre simple
        if (!isNaN(v)) return Number(v);

        // fallback string
        return v.toLowerCase();
    }

    /* =========================
       STATUS ORDER (mÃ©tier)
       ========================= */
    const STATUS_ORDER = {
        "active": 1,
        "pre_expired": 2,
        "reminder": 3,
        "expired": 4,
        "invited": 5,
        "unfriended": 6,
        "suspended": 7,
        "none": 98,
        "unknown": 99
    };

    const sorted = rows.sort((a, b) => {

        /* ðŸ”¥ TRI MÃ‰TIER POUR STATUS (col index 2) */
        if (columnIndex === 2) {
            const getStatusKey = (row) => {
                const span = row.children[2]?.querySelector("span");
                return span?.dataset?.status || "none";
            };

            const A = STATUS_ORDER[getStatusKey(a)] ?? 999;
            const B = STATUS_ORDER[getStatusKey(b)] ?? 999;

            return currentOrder === "asc" ? A - B : B - A;
        }

        /* ðŸ”¹ TRI CLASSIQUE */
        const A = convert(getCellValue(a.children[columnIndex]));
        const B = convert(getCellValue(b.children[columnIndex]));

        if (A > B) return currentOrder === "asc" ? 1 : -1;
        if (A < B) return currentOrder === "asc" ? -1 : 1;
        return 0;
    });

    tbody.innerHTML = "";
    sorted.forEach(r => tbody.appendChild(r));

    localStorage.setItem("users_sort_col", String(columnIndex));
    localStorage.setItem("users_sort_order", currentOrder);
}

/* =========================
   RESTORE SORT + AUTO FILTER
   ========================= */
document.addEventListener("DOMContentLoaded", () => {
    // -------------------------
    // 1) RESTORE SORT STATE
    // -------------------------
    const col = localStorage.getItem("users_sort_col");
    const order = localStorage.getItem("users_sort_order");

    if (col !== null) {
        const th = document.querySelectorAll("th.sortable")[Number(col)];
        if (th) {
            // inversion volontaire car sortTable toggle lâ€™ordre
            th.dataset.order = order === "asc" ? "desc" : "asc";
            sortTable(Number(col), th);
        }
    }

    // -------------------------
    // 2) AUTO FILTER + PERSIST
    // -------------------------
    const form = document.getElementById("users_filter_form");
    if (!form) return;

    const searchInput = form.querySelector('input[name="q"]');
    const statusCheckboxes = form.querySelectorAll('input[name="status"]');

    const STORAGE_KEY = "vodum_users_filters_v1";
    let timer = null;

    function saveFilters() {
        try {
            const statuses = Array.from(statusCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            const q = searchInput ? (searchInput.value || "") : "";

            localStorage.setItem(STORAGE_KEY, JSON.stringify({ statuses, q }));
        } catch (e) {
            console.warn("saveFilters failed", e);
        }
    }

    function submitForm() {
        saveFilters();
        if (form.requestSubmit) form.requestSubmit();
        else form.submit();
    }

    // Restore uniquement si lâ€™URL nâ€™a pas dÃ©jÃ  des filtres
    (function restoreFilters() {
        const url = new URL(window.location.href);
        if (url.searchParams.has("status") || url.searchParams.has("q")) return;

        try {
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");

            // Status : si rien sauvegardÃ© -> on coche tout
            if (Array.isArray(saved.statuses) && saved.statuses.length > 0) {
                statusCheckboxes.forEach(cb => {
                    cb.checked = saved.statuses.includes(cb.value);
                });
            } else {
                statusCheckboxes.forEach(cb => cb.checked = true);
            }

            // Search
            //if (searchInput && typeof saved.q === "string") {
            //    searchInput.value = saved.q;
            //}
			if (searchInput) {
			  searchInput.value = "";
			}

            // Applique seulement si on a qqch Ã  restaurer
            const hasSomething =
                (Array.isArray(saved.statuses) && saved.statuses.length > 0) ||
                (typeof saved.q === "string" && saved.q.trim() !== "");

            if (hasSomething) submitForm();
        } catch (e) {
            console.warn("restoreFilters failed", e);
        }
    })();

    // Search debounce
    if (searchInput) {
        searchInput.addEventListener("input", () => {
            clearTimeout(timer);
            timer = setTimeout(submitForm, 800);
        });

        searchInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                clearTimeout(timer);
                submitForm();
            }
        });
    }

    // Status checkboxes -> submit immÃ©diat
    statusCheckboxes.forEach(cb => {
        cb.addEventListener("change", () => {
            clearTimeout(timer);
            submitForm();
        });
    });
});
</script>


<!-- CREATE USER MODAL -->
<div id="modal_create_user" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/60" onclick="VodumCreateUser.close()"></div>

  <div class="relative max-w-4xl mx-auto mt-16 bg-slate-950 border border-slate-800 rounded-2xl shadow-xl overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
      <div>
        <div class="text-lg font-semibold">Create user</div>
        <div class="text-sm text-slate-400">Create a user on Plex/Jellyfin and in Vodum, assign libraries, send welcome mail.</div>
      </div>
      <button class="text-slate-300 hover:text-white" onclick="VodumCreateUser.close()">âœ•</button>
    </div>

    <div class="p-6 space-y-6 max-h-[75vh] overflow-y-auto">

      <!-- USER FIELDS -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-xs text-slate-400">Email (required for Plex)</label>
          <input id="cu_email" type="email" class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm" placeholder="user@mail.com">
        </div>
        <div>
          <label class="text-xs text-slate-400">Second email (optional)</label>
          <input id="cu_second_email" type="email" class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm" placeholder="backup@mail.com">
        </div>
        <div>
          <label class="text-xs text-slate-400">Username</label>
          <input id="cu_username" type="text" class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm" placeholder="username">
          <div class="text-xs text-slate-500 mt-1">If empty, we'll use email local-part.</div>
        </div>
        <div>
          <label class="text-xs text-slate-400">Expiration date</label>
          <input id="cu_expiration" type="date" class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm">
        </div>
        <div>
          <label class="text-xs text-slate-400">Firstname</label>
          <input id="cu_firstname" type="text" class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm" placeholder="Firstname">
        </div>
        <div>
          <label class="text-xs text-slate-400">Lastname</label>
          <input id="cu_lastname" type="text" class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm" placeholder="Lastname">
        </div>
      </div>

      <div>
        <label class="text-xs text-slate-400">Notes</label>
        <textarea id="cu_notes" rows="3" class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm" placeholder="internal notes..."></textarea>
      </div>

      <!-- SERVERS BLOCKS -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold">Servers & libraries</div>
          <button type="button" class="text-xs px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700" onclick="VodumCreateUser.addServerBlock()">+ Add server</button>
        </div>

        <div id="cu_servers_container" class="space-y-4"></div>

        <div class="text-xs text-slate-500 mt-2">
          Plex: invitation by email (user must accept). Jellyfin: local account created immediately.
        </div>
      </div>

      <!-- FEEDBACK -->
      <div id="cu_feedback" class="hidden rounded-xl border border-slate-800 bg-slate-900 p-3 text-sm"></div>

    </div>

    <div class="flex items-center justify-end gap-2 px-6 py-4 border-t border-slate-800">
      <button type="button" class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" onclick="VodumCreateUser.close()">Cancel</button>
      <button id="cu_submit" type="button" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white" onclick="VodumCreateUser.submit()">Create</button>
    </div>
  </div>
</div>

<script>
(function(){
  const api = {
    servers: '/api/servers',
    libs: (serverId) => `/api/servers/${serverId}/libraries`,
    create: '/api/users/create',
  };

  const state = {
    servers: [],
    blocks: [],
  };

  function el(html){
    const t = document.createElement('template');
    t.innerHTML = html.trim();
    return t.content.firstChild;
  }

  async function fetchJSON(url){
    const r = await fetch(url, {headers:{'Accept':'application/json'}});
    if(!r.ok) throw new Error(`${r.status} ${await r.text()}`);
    return await r.json();
  }

  function pickUrl(s){
    return (s.public_url || s.url || s.local_url || '').trim();
  }

  function feedback(msg, kind='info'){
    const box = document.getElementById('cu_feedback');
    box.classList.remove('hidden');
    box.textContent = msg;
    box.classList.remove('border-emerald-600','border-red-600','border-slate-800');
    if(kind==='success') box.classList.add('border-emerald-600');
    else if(kind==='error') box.classList.add('border-red-600');
    else box.classList.add('border-slate-800');
  }

  function open(){
    document.getElementById('modal_create_user').classList.remove('hidden');
    document.getElementById('cu_feedback').classList.add('hidden');
    if(state.blocks.length===0) addServerBlock();
  }

  function close(){
    document.getElementById('modal_create_user').classList.add('hidden');
  }

  async function initServers(){
    state.servers = await fetchJSON(api.servers);
  }

  function serverOptionsHtml(){
    const opts = state.servers.map(s => {
      const label = `${s.name} (${(s.type||'').toUpperCase()})`;
      return `<option value="${s.id}">${label}</option>`;
    });
    return `<option value="">-- choose server --</option>` + opts.join('');
  }

  async function loadLibraries(serverId){
    if(!serverId) return [];
    return await fetchJSON(api.libs(serverId));
  }

  function renderBlock(blockId){
    const block = state.blocks.find(b => b.id===blockId);
    const node = el(`
      <div class="border border-slate-800 rounded-2xl p-4 bg-slate-950">
        <div class="flex items-center justify-between mb-3">
          <div class="text-sm font-semibold">Server</div>
          <button type="button" class="text-xs px-2 py-1 rounded bg-slate-800 hover:bg-slate-700" data-action="remove">Remove</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs text-slate-400">Server</label>
            <div class="flex gap-2 items-center">
              <select class="flex-1 bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm" data-field="server_id">
                ${serverOptionsHtml()}
              </select>
              <button type="button"
                      class="hidden"
                      title="Add linked Plex servers"
                      data-add-linked>
                +
              </button>
            </div>
            <div class="text-xs text-slate-500 mt-1" data-server-url></div>
            <div class="text-xs text-slate-500 mt-1" data-linked-info></div>
          </div>


          <div>
            <label class="text-xs text-slate-400">Libraries</label>
            <div class="bg-slate-900 border border-slate-800 rounded-lg p-2 text-xs max-h-40 overflow-y-auto" data-libs>
              <div class="text-slate-500">Select a server first</div>
            </div>
          </div>

          <div data-jellyfin class="hidden md:col-span-2">
            <div class="text-xs text-slate-400 mb-1">Jellyfin options</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-slate-500">Initial password (optional)</label>
                <input type="password" class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm" data-field="jellyfin_password" autocomplete="new-password">
              </div>
              <label class="flex items-center gap-2 text-sm mt-5">
                <input type="checkbox" data-field="jellyfin_force_password_change">
                <span class="text-slate-200">Force password change</span>
              </label>
            </div>
          </div>

          <div data-plex class="hidden md:col-span-2">
            <div class="text-xs text-slate-400 mb-1">Plex share flags (stored in details_json)</div>
            <div class="flex flex-wrap gap-4 text-sm">
              <label class="flex items-center gap-2">
                <input type="checkbox" data-plex-flag="allowSync">
                <span>allowSync</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" data-plex-flag="allowCameraUpload">
                <span>allowCameraUpload</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" data-plex-flag="allowChannels">
                <span>allowChannels</span>
              </label>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
              <div>
                <label class="text-xs text-slate-500">filterMovies</label>
                <input type="text" class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm" data-plex-flag="filterMovies">
              </div>
              <div>
                <label class="text-xs text-slate-500">filterTelevision</label>
                <input type="text" class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm" data-plex-flag="filterTelevision">
              </div>
              <div>
                <label class="text-xs text-slate-500">filterMusic</label>
                <input type="text" class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm" data-plex-flag="filterMusic">
              </div>
            </div>

            <label class="flex items-center gap-2 text-sm mt-3">
              <input type="checkbox" data-field="enqueue_plex_jobs">
              <span class="text-slate-200">Enqueue Plex jobs (debug / optional)</span>
            </label>
          </div>
        </div>
      </div>
    `);

    const container = document.getElementById('cu_servers_container');
    container.appendChild(node);

    const select = node.querySelector('[data-field="server_id"]');
    const libsBox = node.querySelector('[data-libs]');
    const serverUrlLine = node.querySelector('[data-server-url]');
    const jellyfinBox = node.querySelector('[data-jellyfin]');
    const plexBox = node.querySelector('[data-plex]');
	const linkedInfo = node.querySelector('[data-linked-info]');
    const btnAddLinked = node.querySelector('[data-add-linked]');


    node.querySelector('[data-action="remove"]').addEventListener('click', () => removeServerBlock(blockId));

    select.addEventListener('change', async () => {
      const serverId = select.value ? parseInt(select.value,10) : null;
      block.server_id = serverId;
      block.library_ids = [];

      const srv = state.servers.find(s => s.id===serverId);
      const provider = (srv?.type||'').toLowerCase();
      block.provider = provider;

      const u = srv ? pickUrl(srv) : '';
	  serverUrlLine.textContent = u ? `URL: ${u}` : '';


      // Show linked Plex servers (same token)
      if(provider === 'plex' && srv?.linked_servers?.length){
        linkedInfo.textContent = `Linked Plex servers: ${srv.linked_servers.map(x => x.name).join(', ')}`;
        btnAddLinked.disabled = false;
      } else {
        linkedInfo.textContent = '';
        btnAddLinked.disabled = true;
      }


      jellyfinBox.classList.toggle('hidden', provider!=='jellyfin');
      plexBox.classList.toggle('hidden', provider!=='plex');

      libsBox.innerHTML = `<div class="text-slate-500">Loading librariesâ€¦</div>`;
      try{
        const libs = await loadLibraries(serverId);
        if(!libs.length){
          libsBox.innerHTML = `<div class="text-slate-500">No libraries found for this server.</div>`;
          return;
        }

        libsBox.innerHTML = libs.map(l => {
          return `
            <label class="flex items-center justify-between gap-2 py-1">
              <span class="text-slate-200">${l.server_name ? (l.server_name + " â€” ") : ""}${l.name}</span>
              <input type="checkbox" data-lib-id="${l.id}">
            </label>
          `;
        }).join('');

        libsBox.querySelectorAll('input[data-lib-id]').forEach(cb => {
          cb.addEventListener('change', () => {
            const id = parseInt(cb.getAttribute('data-lib-id'),10);
            if(cb.checked){
              if(!block.library_ids.includes(id)) block.library_ids.push(id);
            } else {
              block.library_ids = block.library_ids.filter(x => x!==id);
            }
          });
        });

      } catch(e){
        libsBox.innerHTML = `<div class="text-red-400">Failed to load libraries</div>`;
      }
    });



    node.querySelectorAll('[data-field="jellyfin_password"]').forEach(inp => {
      inp.addEventListener('input', () => block.jellyfin_password = inp.value);
    });
    node.querySelectorAll('[data-field="jellyfin_force_password_change"]').forEach(inp => {
      inp.addEventListener('change', () => block.jellyfin_force_password_change = inp.checked);
    });
    node.querySelectorAll('[data-field="enqueue_plex_jobs"]').forEach(inp => {
      inp.addEventListener('change', () => block.enqueue_plex_jobs = inp.checked);
    });

    node.querySelectorAll('[data-plex-flag]').forEach(inp => {
      const key = inp.getAttribute('data-plex-flag');
      inp.addEventListener('input', () => {
        if(!block.plex_share) block.plex_share = {};
        if(inp.type==='checkbox') block.plex_share[key] = inp.checked;
        else block.plex_share[key] = inp.value;
      });
      inp.addEventListener('change', () => {
        if(!block.plex_share) block.plex_share = {};
        if(inp.type==='checkbox') block.plex_share[key] = inp.checked;
        else block.plex_share[key] = inp.value;
      });
    });

    return node;
  }

  function addServerBlock(){
    const id = Math.random().toString(16).slice(2);
    const block = {id, server_id:null, library_ids:[], provider:null};
    state.blocks.push(block);
    renderBlock(id);
  }

  function removeServerBlock(blockId){
    state.blocks = state.blocks.filter(b => b.id!==blockId);
    const container = document.getElementById('cu_servers_container');
    container.innerHTML = '';
    state.blocks.forEach(b => renderBlock(b.id));
  }

  async function submit(){
    const btn = document.getElementById('cu_submit');
    btn.disabled = true;
    feedback('Creatingâ€¦');

    try{
      const email = document.getElementById('cu_email').value.trim();
      const username = document.getElementById('cu_username').value.trim();
      const payload = {
        email,
        second_email: document.getElementById('cu_second_email').value.trim(),
        username,
        firstname: document.getElementById('cu_firstname').value.trim(),
        lastname: document.getElementById('cu_lastname').value.trim(),
        expiration_date: document.getElementById('cu_expiration').value,
        notes: document.getElementById('cu_notes').value.trim(),
        servers: state.blocks
          .filter(b => b.server_id)
          .map(b => ({
            server_id: b.server_id,
            library_ids: b.library_ids || [],
            jellyfin_password: b.jellyfin_password || '',
            jellyfin_force_password_change: !!b.jellyfin_force_password_change,
            plex_share: b.plex_share || {},
            enqueue_plex_jobs: !!b.enqueue_plex_jobs,
          })),
      };

      if(!payload.servers.length){
        feedback('Select at least one server.', 'error');
        return;
      }

      const r = await fetch(api.create, {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'Accept':'application/json'},
        body: JSON.stringify(payload)
      });

      const data = await r.json().catch(()=>({ok:false,error:'Invalid JSON response'}));
      if(!r.ok || !data.ok){
        feedback(data.error || 'Create failed', 'error');
        return;
      }

      let msg = `User created (vodum_user_id=${data.vodum_user_id}).`;
      if(data.provider_errors?.length){
        msg += ` Provider errors: ${data.provider_errors.join(' | ')}`;
      }
      if(data.mailing_errors?.length){
        msg += ` Mailing errors: ${data.mailing_errors.join(' | ')}`;
      }
      feedback(msg, 'success');

      setTimeout(() => window.location.reload(), 800);

    } catch(e){
      feedback(e.message || String(e), 'error');
    } finally {
      btn.disabled = false;
    }
  }

  window.VodumCreateUser = {open, close, addServerBlock, removeServerBlock, submit};

  document.getElementById('btn_create_user')?.addEventListener('click', async () => {
    try{
      if(!state.servers.length) await initServers();
      VodumCreateUser.open();
    }catch(e){
      alert('Failed to load servers: ' + (e.message || e));
    }
  });
})();
</script>


{% endblock %}
