<!-- ========== JELLYFIN BUBBLE (read-only, enriched) ========== -->
{% set jellyfin_accounts = servers | selectattr("media_type", "equalto", "jellyfin") | list %}
{% if jellyfin_accounts %}
  {% set j = jellyfin_accounts[0] %}

  {# raw_json peut être déjà un dict OU une string JSON. On tente de parser si besoin. #}
  {% set jraw = j.raw_json %}
  {% if jraw is string and jraw %}
    {% set jraw = jraw | fromjson %}
  {% endif %}

  {% set policy = (jraw.Policy if jraw and jraw.Policy is defined else {}) %}
  {% set config = (jraw.Configuration if jraw and jraw.Configuration is defined else {}) %}

  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">

    {# CONTENU COMPACTABLE #}
    <div id="jellyfinBox" class="relative overflow-hidden transition-all duration-300 max-h-48">

      <!-- HEADER (title + role badge + avatar) -->
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <h2 class="text-sm font-semibold">Jellyfin</h2>

          {# Role #}
          {% if j.media_role %}
            <span class="px-2 py-0.5 text-xs rounded bg-slate-800 text-slate-200">
              {{ j.media_role }}
            </span>
          {% endif %}

          {# Admin badge from policy if present #}
          {% if policy and policy.IsAdministrator %}
            <span class="px-2 py-0.5 text-xs rounded bg-amber-900/40 text-amber-300">
              admin
            </span>
          {% endif %}

          {% if policy and policy.IsDisabled %}
            <span class="px-2 py-0.5 text-xs rounded bg-rose-900/40 text-rose-300">
              disabled
            </span>
          {% endif %}

          {% if policy and policy.IsHidden %}
            <span class="px-2 py-0.5 text-xs rounded bg-slate-800 text-slate-400">
              hidden
            </span>
          {% endif %}
        </div>

        {# Avatar: priorité à media_avatar (ou avatar) #}
        {% if j.media_avatar %}
          <img src="{{ j.media_avatar }}" alt="Jellyfin avatar"
               class="w-10 h-10 rounded-full border border-slate-700">
        {% elif j.avatar %}
          <img src="{{ j.avatar }}" alt="Jellyfin avatar"
               class="w-10 h-10 rounded-full border border-slate-700">
        {% endif %}
      </div>

      <!-- MAIN INFO GRID -->
      <div class="grid grid-cols-2 gap-y-2 text-sm mt-4">
        <div class="text-slate-400">{{ t("jellyfin_id") if t("jellyfin_id") else "Jellyfin ID" }}</div>
        <div class="font-mono text-slate-200">{{ j.external_user_id or t("not_available") }}</div>

        <div class="text-slate-400">{{ t("username") }}</div>
        <div class="text-slate-200">{{ j.username or t("not_available") }}</div>

        <div class="text-slate-400">{{ t("role") }}</div>
        <div class="text-slate-200">{{ j.media_role or t("not_available") }}</div>

        <div class="text-slate-400">{{ t("joined_at") }}</div>
        <div class="text-slate-200">{{ j.joined_at or t("not_available") }}</div>

        <div class="text-slate-400">Last login</div>
        <div class="text-slate-200">
          {{ jraw.LastLoginDate if jraw and jraw.LastLoginDate is defined else t("not_available") }}
        </div>

        <div class="text-slate-400">Last activity</div>
        <div class="text-slate-200">
          {{ jraw.LastActivityDate if jraw and jraw.LastActivityDate is defined else t("not_available") }}
        </div>

        <div class="text-slate-400">Has password</div>
        <div class="text-slate-200">
          {% if jraw and jraw.HasPassword is defined %}
            {{ "Yes" if jraw.HasPassword else "No" }}
          {% else %}
            {{ t("not_available") }}
          {% endif %}
        </div>

        <div class="text-slate-400">Auto login</div>
        <div class="text-slate-200">
          {% if jraw and jraw.EnableAutoLogin is defined %}
            {{ "Yes" if jraw.EnableAutoLogin else "No" }}
          {% else %}
            {{ t("not_available") }}
          {% endif %}
        </div>
      </div>

      <!-- POLICY BLOCK -->
      <div class="mt-4 bg-slate-950/60 border border-slate-800 rounded-xl p-4">
        <div class="text-xs font-semibold text-slate-300 mb-3">Policy</div>

        <div class="grid grid-cols-2 gap-y-2 text-sm">
          <div class="text-slate-400">Remote access</div>
          <div class="text-slate-200">
            {% if policy and policy.EnableRemoteAccess is defined %}
              {{ "Yes" if policy.EnableRemoteAccess else "No" }}
            {% else %}
              {{ t("not_available") }}
            {% endif %}
          </div>

          <div class="text-slate-400">Media playback</div>
          <div class="text-slate-200">
            {% if policy and policy.EnableMediaPlayback is defined %}
              {{ "Yes" if policy.EnableMediaPlayback else "No" }}
            {% else %}
              {{ t("not_available") }}
            {% endif %}
          </div>

          <div class="text-slate-400">All folders</div>
          <div class="text-slate-200">
            {% if policy and policy.EnableAllFolders is defined %}
              {{ "Yes" if policy.EnableAllFolders else "No" }}
            {% else %}
              {{ t("not_available") }}
            {% endif %}
          </div>

          <div class="text-slate-400">Enabled folders</div>
          <div class="text-slate-200">
            {% if policy and policy.EnabledFolders is defined and policy.EnabledFolders %}
              {{ policy.EnabledFolders | length }}
            {% else %}
              {{ t("not_available") }}
            {% endif %}
          </div>
        </div>
      </div>

      <!-- CONFIG BLOCK -->
      <div class="mt-3 bg-slate-950/60 border border-slate-800 rounded-xl p-4">
        <div class="text-xs font-semibold text-slate-300 mb-3">Configuration</div>

        <div class="grid grid-cols-2 gap-y-2 text-sm">
          <div class="text-slate-400">Audio language</div>
          <div class="text-slate-200">
            {{ config.AudioLanguagePreference if config and config.AudioLanguagePreference is defined and config.AudioLanguagePreference else t("not_available") }}
          </div>

          <div class="text-slate-400">Subtitle language</div>
          <div class="text-slate-200">
            {{ config.SubtitleLanguagePreference if config and config.SubtitleLanguagePreference is defined and config.SubtitleLanguagePreference else t("not_available") }}
          </div>

          <div class="text-slate-400">Auto play next</div>
          <div class="text-slate-200">
            {% if config and config.EnableNextEpisodeAutoPlay is defined %}
              {{ "Yes" if config.EnableNextEpisodeAutoPlay else "No" }}
            {% else %}
              {{ t("not_available") }}
            {% endif %}
          </div>

          <div class="text-slate-400">Remember subtitles</div>
          <div class="text-slate-200">
            {% if config and config.RememberSubtitleSelections is defined %}
              {{ "Yes" if config.RememberSubtitleSelections else "No" }}
            {% else %}
              {{ t("not_available") }}
            {% endif %}
          </div>
        </div>
      </div>

      {# Dégradé bas visible seulement quand replié #}
      <div id="jellyfinFade"
           class="pointer-events-none absolute inset-x-0 bottom-0 h-14 bg-gradient-to-t from-slate-900 to-transparent">
      </div>

    </div>

    {# BOUTON #}
    <div class="mt-3">
      <button type="button"
              id="jellyfinToggle"
              class="w-full px-3 py-2 text-xs rounded-xl border border-slate-800 bg-slate-950/40 text-slate-200 hover:bg-slate-950/70">
        {{ t("collapse_show_more") }}
      </button>
    </div>

  </div>
{% endif %}
