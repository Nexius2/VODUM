<!-- ========== PLEX BUBBLE (read-only) ========== -->
{% set plex_accounts = servers | selectattr("media_type", "equalto", "plex") | list %}
{% set p = plex_accounts[0] if plex_accounts else None %}
{% if p %}
<!-- ========== PLEX BUBBLE (read-only) ========== -->
<div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">

  {# CONTENU COMPACTABLE #}
  <div id="plexBox" class="relative overflow-hidden transition-all duration-300 max-h-48">

    <!-- HEADER -->
    <div class="flex flex-col mb-3">

      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold">Plex</h2>

        {% if p.media_avatar %}
          <img src="{{ p.media_avatar }}"
               alt="Plex avatar"
               class="w-10 h-10 rounded-full border border-slate-700">
        {% elif user.avatar %}
          <img src="{{ user.avatar }}"
               alt="Plex avatar"
               class="w-10 h-10 rounded-full border border-slate-700">
        {% endif %}
      </div>

      <!-- Plex flags -->
      <div class="flex flex-wrap gap-2 mt-2">
        {% if user.home %}
          <span class="px-2 py-0.5 text-xs rounded bg-emerald-900/40 text-emerald-300">
            üè† {{ t("home_user") }}
          </span>
        {% endif %}

        {% if user.protected %}
          <span class="px-2 py-0.5 text-xs rounded bg-purple-900/40 text-purple-300">
            üîí {{ t("protected_account") }}
          </span>
        {% endif %}

        {% if user.restricted %}
          <span class="px-2 py-0.5 text-xs rounded bg-red-900/40 text-red-300 opacity-90">
            ‚õî {{ t("restricted") }}
          </span>
        {% endif %}
      </div>
    </div>

    <!-- INFOS PRINCIPALES -->
    <div class="grid grid-cols-2 gap-y-2 text-sm mt-4">
      <div class="text-slate-400">{{ t("plex_id") }}</div>
      <div class="font-mono text-slate-200">{{ p.external_user_id or t("not_available") }}</div>

      <div class="text-slate-400">{{ t("plex_role") }}</div>
      <div class="text-slate-200">{{ p.media_role or t("not_available") }}</div>

      <div class="text-slate-400">{{ t("joined_at") }}</div>
      <div class="text-slate-200">{{ p.joined_at or t("not_available") }}</div>

      <div class="text-slate-400">{{ t("accepted_at") }}</div>
      <div class="text-slate-200">{{ p.accepted_at or t("not_available") }}</div>
    </div>

    {% if user.subscription_active %}
      <div class="mt-4">
        <span class="px-3 py-1 text-xs rounded-full bg-amber-900/40 text-amber-300">
          ‚≠ê Plex Pass
        </span>
      </div>
    {% endif %}

    <div class="mt-3 bg-slate-950/60 border border-slate-800 rounded-xl p-4">
      <div class="text-xs font-semibold text-slate-300 mb-3">Plex Pass</div>

      <div class="grid grid-cols-2 gap-y-2 text-sm">
        <div class="text-slate-400">{{ t("subscription_active") }}</div>
        <div class="text-slate-200">
          {{ user.subscription_active if user.subscription_active is not none else t("not_available") }}
        </div>

        <div class="text-slate-400">{{ t("subscription_status") }}</div>
        <div class="text-slate-200">{{ user.subscription_status or t("not_available") }}</div>

        <div class="text-slate-400">{{ t("subscription_plan") }}</div>
        <div class="text-slate-200">{{ user.subscription_plan or t("not_available") }}</div>
      </div>
    </div>

    <div id="plexFade"
         class="pointer-events-none absolute inset-x-0 bottom-0 h-14 bg-gradient-to-t from-slate-900 to-transparent">
    </div>

  </div>

  <div class="mt-3">
    <button type="button"
            id="plexToggle"
            class="w-full px-3 py-2 text-xs rounded-xl border border-slate-800 bg-slate-950/40 text-slate-200 hover:bg-slate-950/70">
      {{ t("collapse_show_more") }}
    </button>
  </div>

</div>
{% endif %}
