<!-- ====================== SERVERS + LIBRARIES (UNCHANGED) ====================== -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">

{% for s in servers %}

{# ---------- RAW JSON (1 seule fois) ---------- #}
{% set sraw = s.raw_json if s.raw_json is defined else None %}
{% if sraw is string and sraw %}
  {% set sraw = sraw | fromjson %}
{% endif %}
{% set spolicy = (sraw.Policy if sraw and sraw.Policy is defined else {}) %}

{# ---------- READONLY RULES ---------- #}
{% set is_owner_plex =
    (s.media_type == 'plex')
    and ((s.media_role or '') | lower == 'owner')
%}

{% set is_jellyfin_admin =
    (s.media_type == 'jellyfin')
    and (
        ((s.media_role or '') | lower == 'admin')
        or (spolicy and spolicy.IsAdministrator is defined and spolicy.IsAdministrator)
    )
%}

{% set is_readonly = is_owner_plex or is_jellyfin_admin %}



<div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 flex flex-col gap-4
            {% if is_readonly %} opacity-70 {% endif %}">

	<!-- Server Header -->
	<div class="flex items-start justify-between pb-2">
	  <div>
		<div class="text-sm font-semibold">{{ s.name }}</div>
		<div class="text-xs text-slate-400 break-all">
		  {{ s.url or s.local_url or s.public_url or t("not_available") }}
		</div>

		<!-- {% if is_jellyfin_admin %}
		  <div class="mt-1 text-xs text-amber-300/90">
			üëë Admin Jellyfin : acc√®s complet (modifiable c√¥t√© Jellyfin)
		  </div>
		{% endif %} -->
		{% if settings.debug_mode %}
		  <div class="text-xs text-amber-300">
			DEBUG: type={{ s.media_type }}, role={{ s.media_role }}, readonly={{ is_readonly }}
		  </div>
		{% endif %}


	  </div>

	  {% if s.has_access %}
		<span class="px-3 py-1 rounded-full text-xs bg-emerald-900/40 text-emerald-300">
		  {{ t("access") }}
		</span>
	  {% else %}
		<span class="px-3 py-1 rounded-full text-xs bg-slate-800 text-slate-300">
		  {{ t("no_access") }}
		</span>
	  {% endif %}
	</div>


  <div class="border-t border-slate-700/40"></div>

  <!-- Libraries + Options -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">

    <!-- Libraries -->
    <div class="space-y-2 md:pr-4">
      <div class="font-semibold text-slate-300 text-sm mb-1">{{ t("libraries") }}</div>

      {% set libs_for_server = libraries | selectattr("server_id", "equalto", s.server_id) | list %}

      {% if libs_for_server|length == 0 %}
        <p class="text-xs text-slate-500 italic">{{ t("no_library_for_server") }}</p>
      {% else %}
		{% for lib in libs_for_server %}
		  <form method="post"
				action="{{ url_for('user_toggle_library', user_id=user.id) }}"
				class="flex items-center justify-between py-1 {% if is_readonly %} opacity-70 {% endif %}">

			<div>
			  <input type="hidden" name="library_id" value="{{ lib.id }}">
			  <span class="text-sm">{{ lib.name }}</span>
			  <span class="text-xs text-slate-400">¬∑ {{ t(lib.type) }}</span>
			</div>

			<button type="submit"
					{% if is_readonly %} disabled aria-disabled="true" title="Readonly" {% endif %}
					class="relative inline-flex h-6 w-11 items-center rounded-full transition
						   {% if lib.has_access %} bg-emerald-500 {% else %} bg-slate-600 {% endif %}
						   {% if is_readonly %} cursor-not-allowed opacity-60 {% endif %}">
			  <span class="inline-block h-4 w-4 transform rounded-full bg-white transition
						   {% if lib.has_access %} translate-x-5 {% else %} translate-x-1 {% endif %}"></span>
			</button>

		  </form>
		{% endfor %}


      {% endif %}
    </div>

    <!-- Server options -->
    {# DB v2: on utilise directement s (d√©j√† enrichi c√¥t√© app.py) #}
    {% set o = s %}

	<div class="md:pl-4 md:border-l md:border-slate-700/30 mt-2 md:mt-0">
  <div class="bg-slate-800/40 border border-slate-700 rounded-xl p-3 text-xs space-y-2 h-fit">

    <div class="font-semibold text-slate-300 mb-1">
      {{ t("server_options") }}
    </div>

    {# Les options ci-dessous sont sp√©cifiques Plex. Pour Jellyfin, on affiche "Not available". #}
    {% if s.media_type == 'plex' %}

      {% set debug_disabled = (not settings.debug_mode) %}
      {% set disable_checkbox = (is_owner_plex or debug_disabled) %}
      {% set readonly_text = (is_owner_plex or debug_disabled) %}
      {% set dim_class = "opacity-60 cursor-not-allowed" if (is_owner_plex or debug_disabled) else "" %}

      {# -------------------------- #}
      {# allowSync (toggle auto)    #}
      {# -------------------------- #}
      <form method="POST"
            action="{{ url_for('toggle_plex_share_option', user_id=user.id) }}"
            class="m-0">
        <input type="hidden" name="server_id" value="{{ s.server_id }}">
        <input type="hidden" name="media_user_id" value="{{ s.media_user_id }}">
        <input type="hidden" name="field" value="allowSync">
        <input type="hidden" name="value" value="0">

        <label class="flex justify-between items-center gap-2 {{ dim_class }}">
          {{ t("allow_sync") }}
          <input type="checkbox"
                 name="value"
                 value="1"
                 {% if o.allow_sync %}checked{% endif %}
                 {% if disable_checkbox %}disabled{% endif %}
                 onchange="this.form.submit()">
        </label>
      </form>

      {# -------------------------- #}
      {# allowCameraUpload toggle   #}
      {# -------------------------- #}
      <form method="POST"
            action="{{ url_for('toggle_plex_share_option', user_id=user.id) }}"
            class="m-0">
        <input type="hidden" name="server_id" value="{{ s.server_id }}">
        <input type="hidden" name="media_user_id" value="{{ s.media_user_id }}">
        <input type="hidden" name="field" value="allowCameraUpload">
        <input type="hidden" name="value" value="0">

        <label class="flex justify-between items-center gap-2 {{ dim_class }}">
          {{ t("allow_camera_upload") }}
          <input type="checkbox"
                 name="value"
                 value="1"
                 {% if o.allow_camera_upload %}checked{% endif %}
                 {% if disable_checkbox %}disabled{% endif %}
                 onchange="this.form.submit()">
        </label>
      </form>

      {# -------------------------- #}
      {# allowChannels toggle       #}
      {# -------------------------- #}
      <form method="POST"
            action="{{ url_for('toggle_plex_share_option', user_id=user.id) }}"
            class="m-0">
        <input type="hidden" name="server_id" value="{{ s.server_id }}">
        <input type="hidden" name="media_user_id" value="{{ s.media_user_id }}">
        <input type="hidden" name="field" value="allowChannels">
        <input type="hidden" name="value" value="0">

        <label class="flex justify-between items-center gap-2 {{ dim_class }}">
          {{ t("allow_channels") }}
          <input type="checkbox"
                 name="value"
                 value="1"
                 {% if o.allow_channels %}checked{% endif %}
                 {% if disable_checkbox %}disabled{% endif %}
                 onchange="this.form.submit()">
        </label>
      </form>

      {# -------------------------- #}
      {# Filters (auto save debounce)#}
      {# -------------------------- #}

      <form method="POST"
            action="{{ url_for('update_plex_share_filter', user_id=user.id) }}"
            class="m-0">
        <input type="hidden" name="server_id" value="{{ s.server_id }}">
        <input type="hidden" name="media_user_id" value="{{ s.media_user_id }}">
        <input type="hidden" name="field" value="filterMovies">

        <label class="flex flex-col {{ "opacity-60" if readonly_text else "" }}">
          {{ t("filter_movies") }}
          <input type="text"
                 name="value"
                 value="{{ o.filter_movies }}"
                 {% if readonly_text %}readonly{% endif %}
                 oninput="window.__vodumDebounceSubmit && window.__vodumDebounceSubmit(this.form)"
                 class="mt-1 w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 {% if readonly_text %} cursor-not-allowed {% endif %}">
        </label>
      </form>

      <form method="POST"
            action="{{ url_for('update_plex_share_filter', user_id=user.id) }}"
            class="m-0">
        <input type="hidden" name="server_id" value="{{ s.server_id }}">
        <input type="hidden" name="media_user_id" value="{{ s.media_user_id }}">
        <input type="hidden" name="field" value="filterTelevision">

        <label class="flex flex-col {{ "opacity-60" if readonly_text else "" }}">
          {{ t("filter_television") }}
          <input type="text"
                 name="value"
                 value="{{ o.filter_television }}"
                 {% if readonly_text %}readonly{% endif %}
                 oninput="window.__vodumDebounceSubmit && window.__vodumDebounceSubmit(this.form)"
                 class="mt-1 w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 {% if readonly_text %} cursor-not-allowed {% endif %}">
        </label>
      </form>

      <form method="POST"
            action="{{ url_for('update_plex_share_filter', user_id=user.id) }}"
            class="m-0">
        <input type="hidden" name="server_id" value="{{ s.server_id }}">
        <input type="hidden" name="media_user_id" value="{{ s.media_user_id }}">
        <input type="hidden" name="field" value="filterMusic">

        <label class="flex flex-col {{ "opacity-60" if readonly_text else "" }}">
          {{ t("filter_music") }}
          <input type="text"
                 name="value"
                 value="{{ o.filter_music }}"
                 {% if readonly_text %}readonly{% endif %}
                 oninput="window.__vodumDebounceSubmit && window.__vodumDebounceSubmit(this.form)"
                 class="mt-1 w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 {% if readonly_text %} cursor-not-allowed {% endif %}">
        </label>
      </form>

      {# Debounce JS (1 seul global, safe si d√©j√† pr√©sent ailleurs) #}
      <script>
        window.__vodumDebounceSubmit = window.__vodumDebounceSubmit || (function () {
          let t = null;
          return function (form) {
            if (!form) return;
            clearTimeout(t);
            t = setTimeout(function () { form.submit(); }, 500);
          };
        })();
      </script>

    {% else %}
      <p class="text-xs text-slate-500 italic">{{ t("not_available") }}</p>
    {% endif %}

  </div>
</div>


  </div>

</div>
{% endfor %}

</div>
<div id="mergeOverlay" class="fixed inset-0 z-50 hidden bg-black/70 backdrop-blur-sm">
  <div class="absolute inset-0 flex items-center justify-center p-4 md:p-10">
	<div class="w-full max-w-4xl lg:max-w-5xl max-h-[85vh] bg-slate-900 rounded-2xl border border-slate-800 shadow-xl flex flex-col overflow-hidden">



    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
      <div>
        <h2 class="text-lg font-semibold text-amber-400">{{ t("merge.title") }}</h2>
        <p class="text-xs text-slate-400">
          {{ t("merge.warning") }}
        </p>
      </div>
      <button type="button" onclick="closeMergeOverlay()" class="text-slate-400 hover:text-white">‚úï</button>
    </div>

    <!-- Body -->
    <d<div class="flex-1 flex flex-col min-h-0">

  <!-- ====================== ZONE FIXE (MASTER + ACTIONS) ====================== -->
  <div class="shrink-0 px-6 pt-6 pb-4 space-y-6 border-b border-slate-800 bg-slate-900">

    <!-- Master -->
    <div>
      <div class="text-xs uppercase tracking-wide text-slate-400 mb-2">
        {{ t("merge.master.label") }}
      </div>
      <div class="rounded-xl border border-emerald-700/40 bg-emerald-900/10 p-4">
        <div class="font-medium text-emerald-300">
          {{ user.firstname }} {{ user.lastname }}
          <span class="text-slate-400 text-sm">@{{ user.username }}</span>
        </div>
        <div class="text-sm text-slate-400">{{ user.email or '‚Äî' }}</div>
        <div class="text-xs text-slate-500 mt-1">
          {{ t("merge.master.expiration") }} : {{ user.expiration_date or t("merge.common.unknown") }}
        </div>
      </div>
    </div>

    {# --- BARRE D'ACTIONS FIXE (Show all / Merge / Annuler align√©s) --- #}
    <div class="flex items-center justify-between gap-3">

      <!-- Left: Show all / Show top (uniquement si > 5) -->
      <div class="flex items-center gap-3">
        {% if merge_suggestions|length > 5 %}
          <button type="button"
                  class="px-3 py-2 rounded-lg border border-slate-700 text-slate-300 hover:bg-slate-800 text-sm"
                  onclick="toggleAllMergeCandidates()"
                  id="mergeMoreBtn">
            {{ t("merge_show_all") }} ({{ merge_suggestions|length }})
          </button>
        {% endif %}
      </div>

      <!-- Right: Annuler + Merge -->
      <div class="flex items-center gap-3">

        <button type="button"
                class="px-4 py-2 rounded-lg border border-slate-700 text-slate-300 hover:bg-slate-800"
                onclick="closeMergeOverlay()">
          {{ t("cancel") }}
        </button>

        <form method="post"
              id="mergeForm"
              action="{{ url_for('user_merge', user_id=user.id) }}"
              class="flex items-center">
          <input type="hidden" name="other_id" id="mergeOtherId" value="">

          <button type="submit"
                  id="mergeConfirmBtn"
                  disabled
                  class="px-4 py-2 rounded-lg bg-amber-700 text-white text-sm opacity-50 cursor-not-allowed">
            {{ t("merge_action") }}
          </button>
        </form>

      </div>
    </div>

  </div>


  <!-- ====================== ZONE SCROLL (LISTE CANDIDATS UNIQUEMENT) ====================== -->
  <div class="flex-1 min-h-0 overflow-y-auto px-6 py-6">

    <!-- Candidates -->
    <div>
      <div class="text-xs uppercase tracking-wide text-slate-400 mb-2">
        {{ t("merge_choose_user") }}
      </div>

      <div class="space-y-3">

        {# --- LISTE TOP 5 --- #}
        <div id="mergeCandidatesTop" class="space-y-3">
          {% for cand in merge_suggestions[:5] %}
            <div
              class="merge-candidate cursor-pointer flex items-center justify-between rounded-xl border border-slate-800 bg-slate-950/40 px-4 py-3 hover:border-amber-700"
              data-other-id="{{ cand.id }}"
              tabindex="0"
              role="button"
              aria-selected="false"
            >
              <div>
                <div class="font-medium">
                  {{ cand.firstname or '' }} {{ cand.lastname or '' }}
                  <span class="text-slate-400 text-sm">@{{ cand.username }}</span>
                </div>
                <div class="text-xs text-slate-400">
                  {{ cand.email or '‚Äî' }}
                  ¬∑ score {{ cand.merge_score }}
                </div>
              </div>

              <!--<div class="text-xs text-slate-500">
                {{ t("merge_action") }}
              </div>-->
            </div>
          {% endfor %}
        </div>

        {# --- LISTE COMPLETE (cach√©e par d√©faut) --- #}
        {% if merge_suggestions|length > 5 %}
          <div id="mergeAllCandidates" class="hidden space-y-3">
            {% for cand in merge_suggestions[5:] %}
              <div
                class="merge-candidate cursor-pointer flex items-center justify-between rounded-xl border border-slate-800 bg-slate-950/40 px-4 py-3 hover:border-amber-700"
                data-other-id="{{ cand.id }}"
                tabindex="0"
                role="button"
                aria-selected="false"
              >
                <div>
                  <div class="font-medium">
                    {{ cand.firstname or '' }} {{ cand.lastname or '' }}
                    <span class="text-slate-400 text-sm">@{{ cand.username }}</span>
                  </div>
                  <div class="text-xs text-slate-400">
                    {{ cand.email or '‚Äî' }}
                    ¬∑ score {{ cand.merge_score }}
                  </div>
                </div>

                <div class="text-xs text-slate-500">
                  {{ t("merge_action") }}
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}

      </div>
    </div>

    <!-- ====================== MERGE CONFIRM MODAL (WIDE + SCROLL) ====================== -->
    <div id="mergeConfirmModal"
         class="fixed inset-0 z-[60] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 md:p-8"
         role="dialog"
         aria-modal="true"
         aria-labelledby="mergeConfirmTitle">

      <!-- Panel -->
      <div class="w-full max-w-[1100px]">
        <div class="bg-slate-900 border border-slate-800 rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">

          <!-- Header (fixed) -->
          <div class="px-5 py-4 border-b border-slate-800 flex items-start justify-between">
            <div>
              <div id="mergeConfirmTitle" class="text-sm font-semibold text-amber-300">
                ‚ö†Ô∏è {{ t("merge_confirm_title") }}
              </div>
              <div class="text-xs text-slate-400 mt-1">
                {{ t("merge_confirm_subtitle") }}
              </div>
            </div>

            <button type="button"
                    class="text-slate-400 hover:text-white"
                    onclick="closeMergeConfirmModal()"
                    aria-label="Close">
              ‚úï
            </button>
          </div>

          <!-- Body (scrollable) -->
          <div class="p-5 overflow-y-auto">
            <div class="text-xs text-slate-400 mb-4">
              {{ t("merge_confirm_warning") }}
            </div>

            <!-- Layout: left summary / right preview -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

              <!-- LEFT: Summary + Tip -->
              <div class="lg:col-span-1 space-y-4">

                <!-- Summary cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-3">

                  <!-- Master card -->
                  <div class="rounded-xl border border-emerald-700/40 bg-emerald-900/10 p-4">
                    <div class="text-xs uppercase tracking-wide text-emerald-300/90 mb-2">
                      {{ t("merge_master_user") }}
                    </div>
                    <div class="font-medium text-emerald-200">
                      {{ user.firstname }} {{ user.lastname }}
                      <span class="text-slate-400 text-sm">@{{ user.username }}</span>
                    </div>
                    <div class="text-xs text-slate-400 mt-1">{{ user.email or '‚Äî' }}</div>
                  </div>

                  <!-- Target card -->
                  <div class="rounded-xl border border-amber-700/40 bg-amber-900/10 p-4">
                    <div class="text-xs uppercase tracking-wide text-amber-300/90 mb-2">
                      {{ t("merge_target_user") }}
                    </div>

                    <!-- Filled by JS -->
                    <div id="mergeTargetName" class="font-medium text-amber-200">‚Äî</div>
                    <div id="mergeTargetEmail" class="text-xs text-slate-400 mt-1">‚Äî</div>
                    <div id="mergeTargetScore" class="text-[11px] text-slate-500 mt-2">‚Äî</div>
                  </div>

                </div>

                <!-- Tip bubble -->
                <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4 text-xs text-slate-400">
                  <div class="flex items-start gap-2">
                    <span class="mt-0.5">üß¨</span>
                    <div>
                      <div class="text-slate-300 font-semibold">{{ t("merge_confirm_tip_title") }}</div>
                      <div class="mt-1">{{ t("merge_confirm_tip_text") }}</div>
                    </div>
                  </div>
                </div>

              </div>

              <!-- RIGHT: Preview -->
              <div class="lg:col-span-2">
                <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
                  <div class="flex items-center justify-between mb-3">
                    <div class="text-sm font-semibold text-slate-200">
                      {{ t("merge_preview_title") if t("merge_preview_title") else "R√©sultat apr√®s fusion" }}
                    </div>
                    <div id="mergePreviewLoading" class="text-xs text-slate-500 hidden">Loading‚Ä¶</div>
                  </div>

                  <div id="mergePreviewError" class="hidden text-xs text-rose-300"></div>

                  <div id="mergePreviewContent" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3 text-sm">
                    <!-- rempli par JS -->
                  </div>

                  <div id="mergePreviewChanges" class="mt-4 text-xs text-slate-400 hidden"></div>
                </div>
              </div>

            </div>
          </div>

          <!-- Footer (fixed) -->
          <div class="px-5 py-4 border-t border-slate-800 flex items-center justify-end gap-3">
            <button type="button"
                    class="px-4 py-2 rounded-lg border border-slate-700 text-slate-300 hover:bg-slate-800"
                    onclick="closeMergeConfirmModal()">
              {{ t("cancel") }}
            </button>

            <button type="button"
                    id="mergeFinalConfirmBtn"
                    class="px-4 py-2 rounded-lg bg-amber-700 hover:bg-amber-800 text-white text-sm">
              {{ t("merge_confirm_cta") }}
            </button>
          </div>

        </div>
      </div>
    </div>
    <!-- ====================== /MERGE CONFIRM MODAL ====================== -->

  </div>
</div>
      </div></div>
















  </div>
</div>
</div>

<script>
(() => {
  console.log("merge overlay js loaded");
  // -----------------------
  // Helpers
  // -----------------------
  const $ = (sel, root = document) => root.querySelector(sel);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));


  
  const mergePreviewContent = $('#mergePreviewContent');
  const mergePreviewLoading = $('#mergePreviewLoading');
  const mergePreviewError = $('#mergePreviewError');
  const mergePreviewChanges = $('#mergePreviewChanges');
const TXT_PREVIEW_MOVED_TITLE = {{ t('merge.preview.title')|tojson }};
const TXT_PREVIEW_MEDIA_USERS = {{ t('merge.preview.media_users')|tojson }};
const TXT_PREVIEW_USER_IDENTITIES = {{ t('merge.preview.user_identities')|tojson }};
const TXT_PREVIEW_SENT_EMAILS = {{ t('merge.preview.sent_emails')|tojson }};
const TXT_PREVIEW_MEDIA_JOBS = {{ t('merge.preview.media_jobs')|tojson }};




  function badge(source) {
    if (source === 'master') return `<span class="px-2 py-0.5 text-[11px] rounded bg-emerald-900/40 text-emerald-300">master</span>`;
    if (source === 'target') return `<span class="px-2 py-0.5 text-[11px] rounded bg-amber-900/40 text-amber-300">target</span>`;
    return `<span class="px-2 py-0.5 text-[11px] rounded bg-slate-800 text-slate-300">computed</span>`;
  }

  function row(label, value, source) {
    const v = (value === null || value === undefined || value === '') ? '‚Äî' : String(value);
    return `
      <div class="rounded-lg border border-slate-800 bg-slate-950/60 p-3">
        <div class="flex items-center justify-between gap-2">
          <div class="text-xs text-slate-400">${label}</div>
          ${badge(source)}
        </div>
        <div class="mt-1 text-slate-200 break-words">${v}</div>
      </div>
    `;
  }

  async function loadMergePreview(otherId) {
    if (!mergePreviewContent) return;

    mergePreviewError?.classList.add('hidden');
    mergePreviewChanges?.classList.add('hidden');
    mergePreviewContent.innerHTML = '';
    mergePreviewLoading?.classList.remove('hidden');

    try {
      const url = `/users/{{ user.id }}/merge/preview?other_id=${encodeURIComponent(otherId)}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || 'preview_failed');

      const u = data.result || {};
      const s = data.sources || {};

      // Champs que tu veux ‚Äúcomme user details‚Äù
      mergePreviewContent.innerHTML = [
        row('{{ t("firstname") }}', u.firstname, s.firstname),
        row('{{ t("lastname") }}', u.lastname, s.lastname),
        row('{{ t("email") }}', u.email, s.email),
        row('{{ t("second_email") }}', u.second_email, s.second_email),
        row('{{ t("expiration") }}', u.expiration_date, s.expiration_date),
        row('{{ t("renewal_date") }}', u.renewal_date, s.renewal_date),
        row('{{ t("renewal_method") }}', u.renewal_method, s.renewal_method),
        row('{{ t("notes") }}', u.notes, s.notes),
      ].join('');

		// Bonus ‚Äúce qui bouge‚Äù
		if (mergePreviewChanges && data.changes) {
		  const c = data.changes;

		  mergePreviewChanges.innerHTML = `
			<div class="mt-2">
			  <div class="text-slate-300 font-semibold mb-1">
				${TXT_PREVIEW_MOVED_TITLE} :
			  </div>
			  <ul class="list-disc pl-5 space-y-1">
				<li>${TXT_PREVIEW_MEDIA_USERS}: ${c.media_users_to_move}</li>
				<li>${TXT_PREVIEW_USER_IDENTITIES}: ${c.identities_to_move}</li>
				<li>${TXT_PREVIEW_SENT_EMAILS}: ${c.sent_emails_to_move}</li>
				<li>${TXT_PREVIEW_MEDIA_JOBS}: ${c.media_jobs_to_move}</li>
			  </ul>
			</div>
		  `;

		  mergePreviewChanges.classList.remove('hidden');
		}



    } catch (e) {
      if (mergePreviewError) {
        mergePreviewError.textContent = `Preview error: ${e.message || e}`;
        mergePreviewError.classList.remove('hidden');
      }
    } finally {
      mergePreviewLoading?.classList.add('hidden');
    }
  }



  // -----------------------
  // Elements
  // -----------------------
  const overlay = $('#mergeOverlay');
  const mainForm = $('#user_main_form');

  const mergeAllBox = $('#mergeAllCandidates');
  const mergeMoreBtn = $('#mergeMoreBtn');

  const mergeForm = $('#mergeForm');
  const mergeOtherIdInput = $('#mergeOtherId');
  const mergeConfirmBtn = $('#mergeConfirmBtn');

  // Confirm modal elements
  const mergeConfirmModal = $('#mergeConfirmModal');
  const mergeFinalConfirmBtn = $('#mergeFinalConfirmBtn');
  const mergeTargetName = $('#mergeTargetName');
  const mergeTargetEmail = $('#mergeTargetEmail');
  const mergeTargetScore = $('#mergeTargetScore');

  let selectedCandidateEl = null;

  // Texts (Jinja inside JS = OK)
  const TXT_SHOW_TOP = {{ t('merge_show_top')|tojson }};
  const TXT_SHOW_ALL = {{ (t('merge_show_all') ~ " (" ~ (merge_suggestions|length) ~ ")")|tojson }};

  // -----------------------
  // Overlay open/close
  // -----------------------
  function openMergeOverlay() {
    if (!overlay) return;
    overlay.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
    clearMergeSelection();
  }

  function closeMergeOverlay() {
    if (!overlay) return;
    overlay.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
    closeMergeConfirmModal(); // s√©curit√©
  }

  window.openMergeOverlay = openMergeOverlay;
  window.closeMergeOverlay = closeMergeOverlay;

  // Close overlay when clicking backdrop
  if (overlay) {
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeMergeOverlay();
    });
  }

  // -----------------------
  // Confirm modal open/close
  // -----------------------
  

  
  function openMergeConfirmModal() {
    if (!mergeConfirmModal) return;
    mergeConfirmModal.classList.remove('hidden');
    // on laisse overflow-hidden actif (overlay d√©j√† ouvert)
  }

  function closeMergeConfirmModal() {
    if (!mergeConfirmModal) return;
    mergeConfirmModal.classList.add('hidden');
  }

  window.closeMergeConfirmModal = closeMergeConfirmModal;

  if (mergeConfirmModal) {
    mergeConfirmModal.addEventListener('click', (e) => {
      if (e.target === mergeConfirmModal) closeMergeConfirmModal();
    });
  }

  // -----------------------
  // Prevent Enter submit in main form inputs (except textarea)
  // -----------------------
  if (mainForm) {
    mainForm.addEventListener('keydown', (e) => {
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : '';
      if (e.key === 'Enter' && tag === 'INPUT') e.preventDefault();
    });
  }

  // -----------------------
  // Inject dynamic fields on submit (libraries + options)
  // -----------------------
  if (mainForm) {
    mainForm.addEventListener('submit', () => {
      $$('input[data-dyn="1"]', mainForm).forEach(el => el.remove());

      // Libraries toggles
      $$('form[action*="toggle_library"]').forEach(f => {
        const libInput = $('input[name="library_id"]', f);
        if (!libInput) return;

        const libId = libInput.value;
        const btn = $('button', f);
        const enabled = !!(btn && btn.classList.contains('bg-emerald-500'));

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'library_' + libId;
        input.value = enabled ? '1' : '0';
        input.setAttribute('data-dyn', '1');
        mainForm.appendChild(input);
      });

      // Server options
      const selectors = [
        'input[name^="allow_sync_"]',
        'input[name^="allow_camera_upload_"]',
        'input[name^="allow_channels_"]',
        'input[name^="filter_movies_"]',
        'input[name^="filter_television_"]',
        'input[name^="filter_music_"]'
      ];

      $$(selectors.join(',')).forEach(el => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = el.name;
        input.value = (el.type === 'checkbox') ? (el.checked ? '1' : '0') : (el.value || '');
        input.setAttribute('data-dyn', '1');
        mainForm.appendChild(input);
      });
    });
  }

  // -----------------------
  // Merge selection
  // -----------------------
  function clearMergeSelection() {
    $$('.merge-candidate').forEach(x => {
      x.classList.remove('border-amber-700', 'bg-amber-900/10');
      x.classList.add('border-slate-800');
      x.setAttribute('aria-selected', 'false');
    });

    selectedCandidateEl = null;

    if (mergeOtherIdInput) mergeOtherIdInput.value = '';

    if (mergeConfirmBtn) {
      mergeConfirmBtn.disabled = true;
      mergeConfirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
      mergeConfirmBtn.classList.remove('hover:bg-amber-800');
    }
  }

  function fillConfirmModalFromCandidate(el) {
    if (!el) return;

    // name line (contains firstname lastname + @username)
    if (mergeTargetName) {
      const nameLine = (el.querySelector('.font-medium')?.innerText || '‚Äî').trim();
      mergeTargetName.textContent = nameLine;
    }

    // email + score line
    const info = (el.querySelector('.text-xs.text-slate-400')?.innerText || '').trim();
    const parts = info.split('¬∑').map(x => x.trim());

    if (mergeTargetEmail) mergeTargetEmail.textContent = parts[0] || '‚Äî';
    if (mergeTargetScore) mergeTargetScore.textContent = parts[1] ? `(${parts[1]})` : '‚Äî';
  }

  function selectMergeCandidate(el) {
    if (!el) return;

    clearMergeSelection();
    selectedCandidateEl = el;

    el.classList.remove('border-slate-800');
    el.classList.add('border-amber-700', 'bg-amber-900/10');
    el.setAttribute('aria-selected', 'true');

    const otherId = el.getAttribute('data-other-id') || '';
    if (mergeOtherIdInput) mergeOtherIdInput.value = otherId;

    if (mergeConfirmBtn && otherId) {
      mergeConfirmBtn.disabled = false;
      mergeConfirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      mergeConfirmBtn.classList.add('hover:bg-amber-800');
    }

    fillConfirmModalFromCandidate(el);
  }

  // Single click handler (NO DOUBLE)
  document.addEventListener('click', (e) => {
    const item = e.target.closest && e.target.closest('.merge-candidate');
    if (!item) return;
    selectMergeCandidate(item);
  });

  // Keyboard accessibility: Enter/Space
  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter' && e.key !== ' ') return;
    const active = document.activeElement;
    if (!active) return;
    if (active.classList && active.classList.contains('merge-candidate')) {
      e.preventDefault();
      selectMergeCandidate(active);
    }
  });

  // -----------------------
  // Toggle show all / show top
  // -----------------------
  function toggleAllMergeCandidates() {
    if (!mergeAllBox || !mergeMoreBtn) return;
    const willShow = mergeAllBox.classList.contains('hidden');
    mergeAllBox.classList.toggle('hidden');
    mergeMoreBtn.textContent = willShow ? TXT_SHOW_TOP : TXT_SHOW_ALL;
  }

  window.toggleAllMergeCandidates = toggleAllMergeCandidates;

  // -----------------------
  // Merge submit -> open confirm modal (no browser confirm)
  // -----------------------
  if (mergeForm) {
    mergeForm.addEventListener('submit', (e) => {
      e.preventDefault();

      // No selection? do nothing
      if (!mergeOtherIdInput || !mergeOtherIdInput.value) return;

      // Make sure modal displays latest selected candidate
      fillConfirmModalFromCandidate(selectedCandidateEl);

	  loadMergePreview(mergeOtherIdInput.value);
      openMergeConfirmModal();
    });
  }

  // Final confirm button actually submits
  if (mergeFinalConfirmBtn && mergeForm) {
    mergeFinalConfirmBtn.addEventListener('click', () => {
      if (!mergeOtherIdInput || !mergeOtherIdInput.value) return;
      closeMergeConfirmModal();
      mergeForm.submit();
    });
  }

})();
</script>
<script>
  (function () {
    const box = document.getElementById("plexBox");
    const btn = document.getElementById("plexToggle");
    const fade = document.getElementById("plexFade");
    if (!box || !btn) return;

    // Traductions inject√©es depuis Jinja
    const TXT_SHOW_MORE = {{ t("collapse_show_more") | tojson }};
    const TXT_SHOW_LESS = {{ t("collapse_show_less") | tojson }};

    let expanded = false;

    btn.addEventListener("click", () => {
      expanded = !expanded;

      if (expanded) {
        box.classList.remove("max-h-48");
        box.classList.add("max-h-[9999px]");
        if (fade) fade.classList.add("hidden");
        btn.textContent = TXT_SHOW_LESS;
      } else {
        box.classList.add("max-h-48");
        box.classList.remove("max-h-[9999px]");
        if (fade) fade.classList.remove("hidden");
        btn.textContent = TXT_SHOW_MORE;
      }
    });
  })();
</script>
<script>
  (function () {
    const box = document.getElementById("jellyfinBox");
    const btn = document.getElementById("jellyfinToggle");
    const fade = document.getElementById("jellyfinFade");
    if (!box || !btn) return;

    const TXT_MORE = {{ t("collapse_show_more") | tojson }};
    const TXT_LESS = {{ t("collapse_show_less") | tojson }};

    let expanded = false;

    btn.addEventListener("click", () => {
      expanded = !expanded;

      if (expanded) {
        box.classList.remove("max-h-48");
        box.classList.add("max-h-[9999px]");
        if (fade) fade.classList.add("hidden");
        btn.textContent = TXT_LESS;
      } else {
        box.classList.add("max-h-48");
        box.classList.remove("max-h-[9999px]");
        if (fade) fade.classList.remove("hidden");
        btn.textContent = TXT_MORE;
      }
    });
  })();
</script>
<script>
  (function () {
    const box = document.getElementById("emailsBox");
    const inner = document.getElementById("emailsInner");
    const fade = document.getElementById("emailsFade");
    const btn = document.getElementById("emailsToggle");
    const btnWrap = document.getElementById("emailsToggleWrap");
    if (!box || !inner || !btn || !btnWrap) return;

    const TXT_MORE = {{ t("collapse_show_more") | tojson }};
    const TXT_LESS = {{ t("collapse_show_less") | tojson }};

    // Hauteur "repli√©e" (doit matcher max-h-48 = 12rem = ~192px)
    const COLLAPSED_PX = 192;

    let expanded = false;

    function needsToggle() {
      // Si le contenu total d√©passe la hauteur repli√©e -> on affiche le bouton
      return inner.scrollHeight > COLLAPSED_PX + 1;
    }

    function applyState() {
      if (expanded) {
        box.classList.remove("max-h-48");
        box.classList.add("max-h-[9999px]");
        inner.classList.remove("overflow-y-auto");
        if (fade) fade.classList.add("hidden");
        btn.textContent = TXT_LESS;
      } else {
        box.classList.add("max-h-48");
        box.classList.remove("max-h-[9999px]");
        inner.classList.add("overflow-y-auto");
        if (fade) fade.classList.remove("hidden");
        btn.textContent = TXT_MORE;
      }
    }

    // Affiche/masque le bouton uniquement si n√©cessaire
    if (needsToggle()) {
      btnWrap.classList.remove("hidden");
      applyState();
    } else {
      // pas besoin de bouton, pas de fade non plus
      btnWrap.classList.add("hidden");
      if (fade) fade.classList.add("hidden");
      // et on enl√®ve la limite si tu veux (optionnel)
      box.classList.remove("max-h-48");
      box.classList.add("max-h-[9999px]");
      inner.classList.remove("overflow-y-auto");
    }

    btn.addEventListener("click", () => {
      expanded = !expanded;
      applyState();
    });

    // Optionnel: si la page se redimensionne (responsive), on recheck
    window.addEventListener("resize", () => {
      if (needsToggle()) {
        btnWrap.classList.remove("hidden");
        // si on √©tait "expanded", on laisse expanded
        applyState();
      } else {
        btnWrap.classList.add("hidden");
        if (fade) fade.classList.add("hidden");
        box.classList.remove("max-h-48");
        box.classList.add("max-h-[9999px]");
        inner.classList.remove("overflow-y-auto");
      }
    });
  })();
</script>